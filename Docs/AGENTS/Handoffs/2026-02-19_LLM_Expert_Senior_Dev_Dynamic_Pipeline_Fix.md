# 2026-02-19 | LLM Expert + Senior Developer | Claude Code (Sonnet 4.6) + Claude Opus 4.6 | Dynamic Pipeline `AI_NoObjectGeneratedError` Fix

## Task

Investigate and fix the recurring `AI_NoObjectGeneratedError: response did not match schema` failure in the Monolithic Dynamic pipeline (`monolithic_dynamic`). The failure presented as a hard 100% job FAILED with no partial output. Example job ID: `88bce87d91db4fee8af486935c43b17f`, input: German conspiracy theory about child trafficking.

## Root Cause Analysis

Two agents ran parallel investigations (LLM Expert + Opus Software Engineer) and converged on the same diagnosis.

### Primary root cause (HIGH confidence): `searchQueries` was a required Zod field with no prompt guidance

`DynamicAnalysisSchemaAnthropic.searchQueries: z.array(z.string())` — non-optional, required.

The `DYNAMIC_ANALYSIS` prompt section never mentions `searchQueries`. The LLM is synthesizing evidence, not echoing back planning-stage queries. The pipeline already collects queries programmatically in a separate array. The LLM had no reason to include this field → Zod rejected the output → `NoObjectGeneratedError`.

Confirmed via `schema.safeParse({ summary: '...', verdict: {...} })` → fails with `invalid_type: expected array, received undefined` at `["searchQueries"]`.

The field is architecturally redundant: result JSON (line 722) uses the programmatic `searchQueries[]` array, not the LLM's output.

### Secondary root cause (MEDIUM-HIGH confidence): `additionalInsights: z.object({})` too strict

`DynamicAnalysisSchemaAnthropic.additionalInsights: z.object({}).optional()` — the Anthropic variant diverged from the non-Anthropic schema (`z.any().optional()`). LLMs commonly emit `null` for empty optional objects. `z.object({}).optional().safeParse(null)` → fails. The JSON Schema generated by `z.object({})` also has `additionalProperties: false`, which may push the LLM toward `null` instead of `{}`.

### Amplifying factor (CONFIRMED): `schema-retry.ts` existed but was not wired in

`apps/web/src/lib/analyzer/schema-retry.ts` was built specifically for this failure pattern — it handles `NoObjectGeneratedError`, attempts JSON extraction from the error payload, and provides Zod-aware retry prompts. But `monolithic-dynamic.ts` never imported or used it. The bare `generateText` call had no retry, no catch, and no fallback.

### Other factors investigated and ranked

| Factor | Confidence | Notes |
|--------|-----------|-------|
| Content-policy soft refusal producing partial JSON | MEDIUM | Input was sensitive conspiracy content. Not a hard refusal (finishReason was "stop"), but may produce minimal JSON that omits optional fields. Fixed by schema changes. |
| Timeout / truncated JSON | LOW (ruled out) | Error was "did not match schema" (Zod validation path), not "could not parse" (JSON parse path). Pipeline ran 72s vs 150s timeout. |

## Files Changed

| File | Change |
|------|--------|
| `apps/web/src/lib/analyzer/monolithic-dynamic.ts` | Import `generateWithSchemaRetry`; fix `searchQueries` → `.optional()` in both schemas; fix `additionalInsights` → `z.any().optional()` in Anthropic schema; replace bare `generateText` analysis call with `generateWithSchemaRetry` wrapper (1 retry) + graceful degradation catch block |
| `apps/web/src/lib/analyzer/types.ts` | Added `"analysis_generation_failed"` to `AnalysisWarningType` union |

## Key Decisions

- **Make `searchQueries` optional, not remove it** — removing would break non-Anthropic schema symmetry and might affect any future use case; making it optional is safe and minimal.
- **1 retry (not 2+)** — `maxRetries: 1` balances reliability vs. cost. A Zod-aware retry prompt should fix most schema omissions in one attempt.
- **Graceful degradation over throwing** — On all-retries-exhausted, the pipeline returns a partial result (summary = failure message, verdict = null, findings = [], limitations = advice to use CB pipeline). Citations collected during research are preserved. Job status becomes COMPLETED with warnings, not FAILED.
- **`analysis_generation_failed` warning type** — Added to `AnalysisWarningType` to give UI a typed surface for this failure mode. No `as any` casts.
- **Prompt framing NOT changed** — Both agents identified that adding explicit fact-checking framing to `DYNAMIC_ANALYSIS` could reduce soft refusals on sensitive content. Deferred per AGENTS.md: prompt changes require explicit Captain approval.

## Behavior Change

| | Before | After |
|--|--------|-------|
| Schema validation failure | `AI_NoObjectGeneratedError` → unhandled throw → job **FAILED** | Schema fixes prevent the primary cause; 1 Zod-aware retry catches remnants |
| All retries exhausted | N/A (no retries) | Degraded result returned: citations + searchQueries visible, `UNVERIFIED` verdict, `analysis_generation_failed` warning in `analysisWarnings[]` |
| Content-sensitive inputs | Hard failure on schema mismatch | Same protections apply; soft-refusal partial JSON gets a retry with error-specific guidance |

## Verification

- 853 tests pass (`npm test`)
- TypeScript compiles clean (`npx tsc --noEmit`)
- Changes **not yet committed**

## Open Items

- **Prompt framing for sensitive content** (P2, needs Captain approval): Add explicit fact-checking context to `DYNAMIC_ANALYSIS` system prompt to reduce soft refusals on conspiracy/disinformation inputs.
- **Dead code cleanup** (noted by Code Reviewer, pre-existing): Old hardcoded `DYNAMIC_BUDGET` constant at `monolithic-dynamic.ts:~107-112` superseded by config-driven `dynamicBudget`. Should be removed.
- **Schema unification**: `DynamicAnalysisSchema` and `DynamicAnalysisSchemaAnthropic` still have minor divergences (`.min(0).max(100)` vs bare `.number()` on verdict score/confidence). Low risk but inconsistent.
- **No `maxOutputTokens` set** on the analysis `generateText` call — no ceiling on output token cost per call. Opus agent flagged as a budget safety concern.

## Warnings

- The graceful degradation path returns `analysisMode: "dynamic_degraded"` in `meta`. If any UI code conditionally checks `analysisMode === "dynamic"`, it should also handle `"dynamic_degraded"`.
- `analysis_generation_failed` warnings appear in `resultJson.analysisWarnings[]`. The UI already surfaces other warning types from this array — verify `analysis_generation_failed` is handled or at minimum not suppressed.
- The PLAN stage (`generateText` with `DynamicPlanSchema`) still has no retry wrapper. It has succeeded reliably (it runs before sensitive content synthesis), but if it starts failing, the same pattern should be applied there.

## For Next Agent

The Dynamic pipeline is now resilient to schema validation failures. Key entry point: `runMonolithicDynamic()` in `monolithic-dynamic.ts`. The analysis call is now at lines ~563-618 (try/catch with `generateWithSchemaRetry`). The graceful degradation produces a result that is visually different (no verdict pill, failure message in summary) — the UI should handle this gracefully. Check `apps/web/src/app/jobs/[id]/page.tsx` if verdict-absent rendering needs improvement for degraded results.

**Changes are uncommitted** — include with the claim fidelity changes in the next commit.
