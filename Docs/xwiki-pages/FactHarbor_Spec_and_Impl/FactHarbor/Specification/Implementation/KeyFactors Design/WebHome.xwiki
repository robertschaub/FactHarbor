= KeyFactors Design Decision =

**Date**: January 2026
**Version**: 2.6.33
**Status**: Design Decision Document

== Executive Summary ==

This document captures the design decisions around **KeyFactors** in FactHarbor's fact-checking architecture. After analysis, we concluded that:

1. **KeyFactors are decomposition questions** that break down a thesis into verifiable dimensions
1. **KeyFactors should be optional and emergent**, not forced templates
1. **KeyFactors are discovered during understanding**, not verdict generation
1. **Scenario was rejected** as a first-class entity (derivable from existing data)

----

== 1. What is a KeyFactor? ==

=== Definition ===

A **KeyFactor** is an **evaluation dimension** - a question that must be answered to verify a thesis. It represents a structured decomposition of "what must be true for the thesis to be true?"

=== Examples ===

|= Thesis |= KeyFactors (Decomposition Questions)
| "The Bolsonaro trial was fair" | Was due process followed? Was evidence properly considered? Was the judge impartial? Was the outcome proportionate?
| "Vaccine X causes autism" | Is there a documented causal mechanism? Do controlled studies support this? What does scientific consensus say?
| "Company Y committed fraud" | Were financial statements misrepresented? Was there intent to deceive? Were stakeholders harmed?

=== KeyFactor vs Claim ===

{{code}}
┌─────────────────────────────────────────────────────────────────┐
│                         THESIS                                   │
│              "The Bolsonaro trial was fair"                     │
└─────────────────────────────────────────────────────────────────┘
                              │
            ┌─────────────────┼─────────────────┐
            ▼                 ▼                 ▼
┌───────────────────┐ ┌───────────────────┐ ┌───────────────────┐
│    KEY FACTOR     │ │    KEY FACTOR     │ │    KEY FACTOR     │
│  "Due process     │ │  "Evidence basis" │ │  "Impartiality"   │
│   followed?"      │ │                   │ │                   │
└───────────────────┘ └───────────────────┘ └───────────────────┘
         │                    │                      │
    ┌────┴────┐          ┌────┴────┐           ┌────┴────┐
    ▼         ▼          ▼         ▼           ▼         ▼
┌───────┐ ┌───────┐ ┌───────┐ ┌───────┐  ┌───────┐ ┌───────┐
│ Claim │ │ Claim │ │ Claim │ │ Claim │  │ Claim │ │ Claim │
│  SC1  │ │  SC2  │ │  SC3  │ │  SC4  │  │  SC5  │ │  SC6  │
└───────┘ └───────┘ └───────┘ └───────┘  └───────┘ └───────┘
{{/code}}

|= Entity |= Level |= What it represents
| **Thesis** | Highest | The main assertion to verify
| **KeyFactor** | Middle | Evaluation dimension / decomposition question
| **Claim** | Lowest | Atomic verifiable assertion

----

== 2. Entity Relationship Model ==

{{mermaid}}
erDiagram
    ANALYSIS ||--o| ARTICLE : "analyzes"
    ANALYSIS ||--|| THESIS : "has"
    ANALYSIS ||--o{ KEY_FACTOR : "decomposes into"
    ANALYSIS ||--|| OVERALL_VERDICT : "produces"

    ARTICLE ||--|{ CLAIM : "contains"

    THESIS ||--o{ KEY_FACTOR : "decomposed by"

    KEY_FACTOR ||--o{ CLAIM : "answered by"
    KEY_FACTOR ||--o| CONTESTATION : "may have"
    KEY_FACTOR ||--|| FACTOR_VERDICT : "has"

    CLAIM ||--o{ EVIDENCE : "supported by"
    CLAIM ||--|| CLAIM_VERDICT : "has"

    EVIDENCE }o--|| SOURCE : "from"

    FACTOR_VERDICT }o--o{ CLAIM_VERDICT : "aggregates"
    OVERALL_VERDICT }o--o{ FACTOR_VERDICT : "derived from"
    OVERALL_VERDICT }o--o{ CLAIM_VERDICT : "also considers"

    ANALYSIS {
        string id PK
        string inputType "text|url"
        string inputValue
        datetime createdAt
    }

    ARTICLE {
        string id PK
        string url
        string title
        string fullText
    }

    THESIS {
        string id PK
        string statement "main claim or question"
        string impliedClaim "what YES would confirm"
    }

    KEY_FACTOR {
        string id PK
        string question "decomposition question"
        string factor "short label"
        string category "procedural|evidential|methodological"
    }

    FACTOR_VERDICT {
        string id PK
        string supports "yes|no|neutral"
        string explanation
    }

    CLAIM {
        string id PK
        string text
        string type "legal|procedural|factual|evaluative"
        string role "core|attribution|source|timing"
        boolean isCentral
        string keyFactorId FK "which factor this answers"
    }

    EVIDENCE {
        string id PK
        string fact
        string category
        string sourceExcerpt
        boolean isContestedClaim
    }

    SOURCE {
        string id PK
        string url
        string title
        float trackRecordScore
    }

    CONTESTATION {
        string id PK
        string contestedBy
        string factualBasis "established|disputed|opinion|unknown"
        string reason
    }

    CLAIM_VERDICT {
        string id PK
        string verdict "7-point scale"
        int truthPercentage
        string reasoning
    }

    OVERALL_VERDICT {
        string id PK
        string verdict
        int truthPercentage
        string verdictReason
    }
{{/mermaid}}

----

== 3. Data Flow ==

{{mermaid}}
flowchart TD
    subgraph "Step 1: Understand"
        INPUT[User Input] --> DETECT[Detect Input Type]
        DETECT --> THESIS_EXT[Extract Thesis]
        THESIS_EXT --> DECOMPOSE[Decompose into KeyFactors]
        DECOMPOSE --> CLAIMS_EXT[Extract Claims per Factor]
    end

    subgraph "Step 2: Research"
        CLAIMS_EXT --> SEARCH[Search for Evidence]
        SEARCH --> FETCH[Fetch Sources]
        FETCH --> EXTRACT[Extract Facts]
    end

    subgraph "Step 3: Verdict Generation"
        EXTRACT --> CLAIM_EVAL[Evaluate Each Claim]
        CLAIM_EVAL --> FACTOR_AGG[Aggregate by KeyFactor]
        FACTOR_AGG --> CONTEST[Identify Contestations]
        CONTEST --> OVERALL[Generate Overall Verdict]
    end

    subgraph "Output"
        OVERALL --> RESULT[Analysis Result]
        RESULT --> KF_OUT[KeyFactors with verdicts]
        RESULT --> CV_OUT[Claim Verdicts]
        RESULT --> OV_OUT[Overall Verdict]
    end
{{/mermaid}}

----

== 4. Design Decisions ==

=== Decision 1: KeyFactors are Optional and Emergent ===

**Rejected Approach**: Force a fixed template of 5 factors for every analysis.

**Adopted Approach**: KeyFactors emerge from thesis decomposition. The number and type depend on the specific claim being analyzed.

{{code language="typescript"}}
// BAD: Forced template
const FACTORS = ["Process", "Evidence", "Impartiality", "Proportionality", "Compliance"];

// GOOD: Emergent from thesis
const factors = await decomposeThesis(thesis);
// Could return 2 factors, 5 factors, or none
{{/code}}

**Rationale**:
* Different claims require different evaluation dimensions
* Forcing irrelevant factors creates noise
* LLM can identify what dimensions actually matter

**Optional Hints (v2.6.18+)**:
While KeyFactors remain emergent, you can optionally provide hints via ##FH_KEYFACTOR_HINTS## environment variable. These are **suggestions only** - the LLM can consider them but is not required to use them. This allows domain-specific guidance without enforcing irrelevant factors.

**Example Configuration**:
{{code language="bash"}}
# In .env.local or environment
FH_KEYFACTOR_HINTS='[{"question":"Was due process followed?","factor":"Due Process","category":"procedural"},{"question":"Was evidence properly considered?","factor":"Evidence Basis","category":"evidential"}]'
{{/code}}

**Usage**: The hints appear in the prompt as optional suggestions. The LLM will only use them if they genuinely apply to the thesis being analyzed.

=== Decision 2: KeyFactors are Discovered During Understanding ===

**Rejected Approach**: Generate KeyFactors during verdict generation.

**Adopted Approach**: Discover KeyFactors in Step 1 (Understand), so research can be directed toward answering them.

{{mermaid}}
flowchart LR
    subgraph "Understanding Phase"
        T[Thesis] --> KF[KeyFactors]
        KF --> C[Claims mapped to factors]
    end

    subgraph "Research Phase"
        C --> R[Research guided by factors]
    end

    subgraph "Verdict Phase"
        R --> V[Verdicts per factor]
    end
{{/mermaid}}

**Rationale**:
* KeyFactors guide what evidence to search for
* Claims should be organized by the factor they address
* Verdict is aggregation, not discovery

=== Decision 3: Scenario Rejected as First-Class Entity ===

**Rejected**: Creating a ##Scenario## entity to represent competing narratives.

**Rationale**:
* Scenarios are derivable from existing data (contestation metadata)
* Adding Scenario increases schema complexity
* Risk of creating false equivalence between well-supported and poorly-supported interpretations
* Contestation already captures "who disputes what"

**Alternative**: Display "Competing Interpretations" as a derived view when relevant.

=== Decision 4: KeyFactor Contestation Structure ===

Contestation attaches to KeyFactors (not Claims) because:
* Political disputes are usually about evaluation dimensions ("was it fair?")
* Not about atomic facts ("court met on date X")

{{code language="typescript"}}
interface KeyFactor {
  factor: string;
  question: string;
  supports: "yes" | "no" | "neutral";
  explanation: string;

  // Contestation
  isContested: boolean;
  contestedBy: string;           // e.g. "stakeholder group", "opposition coalition", "industry association"
  factualBasis: "established" | "disputed" | "opinion" | "unknown";
}
{{/code}}

**factualBasis Rules (v2.8 - Affects Weight Calculation):**

|= Value |= Meaning |= Weight |= Example
| ##established## | Strong documented counter-evidence | 0.3x | Court transcripts showing bias
| ##disputed## | Some factual counter-evidence | 0.5x | Conflicting expert opinions
| ##opinion## | No factual counter-evidence (DOUBTED) | 1.0x | "Critics say it was unfair"
| ##alleged## | Accusation without evidence (DOUBTED) | 1.0x | Political statements
| ##unknown## | Cannot determine | 1.0x | Insufficient information

**Key Distinction (v2.8):**
* **DOUBTED** (##opinion##/##alleged##/##unknown##): Political rhetoric without evidence -> Full weight
* **CONTESTED** (##established##/##disputed##): Has documented counter-evidence -> Reduced weight

See [[Terminology>>FactHarbor.Specification.Reference.Terminology.WebHome]] for detailed explanation.

----

== 5. Relationship to Claims ==

KeyFactors and Claims have a **parent-child relationship**:

{{mermaid}}
graph TD
    KF1[KeyFactor: Due Process] --> C1[Claim: Court followed procedures]
    KF1 --> C2[Claim: Defendant had legal representation]
    KF1 --> C3[Claim: Appeals process was available]

    KF2[KeyFactor: Evidence Basis] --> C4[Claim: Ruling cited documented evidence]
    KF2 --> C5[Claim: Video evidence was authenticated]

    KF3[KeyFactor: Impartiality] --> C6[Claim: Judge had no conflicts of interest]
    KF3 --> C7[Claim: Judge served on both cases]

    style KF1 fill:#e1f5fe
    style KF2 fill:#e1f5fe
    style KF3 fill:#e1f5fe
    style C1 fill:#fff3e0
    style C2 fill:#fff3e0
    style C3 fill:#fff3e0
    style C4 fill:#fff3e0
    style C5 fill:#fff3e0
    style C6 fill:#fff3e0
    style C7 fill:#fff3e0
{{/mermaid}}

**KeyFactor verdict** = Aggregation of claim verdicts that address that factor.

----

== 6. Implementation Notes ==

=== Current State (v2.6.18 - Updated January 6, 2026) ===

**Completed:**
* KeyFactors discovered in Understanding phase (schema includes ##keyFactors## array)
* Factors are emergent and optional (no forced template)
* Claim-to-factor mapping exists (##keyFactorId## in claim schema)
* KeyFactors aggregated from claim verdicts (aggregation logic exists)
* KeyFactors displayed in question mode reports
* KeyFactors displayed in article mode reports (added January 6, 2026)
* **Optional KeyFactor hints** via ##FH_KEYFACTOR_HINTS## environment variable (suggestions only, not enforced)

**Fixed (January 6, 2026):**
* **Issue**: ##keyFactorId## from ##understanding.subClaims## was not preserved when creating ##ClaimVerdict## objects
* **Impact**: Aggregation found 0 claims per factor (log showed "0 factors from 5 discovered")
* **Fix Applied**:
*# Added ##keyFactorId?: string## to ##ClaimVerdict## interface
*# Preserved ##claim.keyFactorId## when mapping from ##understanding.subClaims## to ##claimVerdicts## (all 3 paths)
*# Aggregation logic should now work correctly
* **Status**: Ready for end-to-end validation

**Removed/Deprecated:**
* ~~Fixed set of 5 factors in prompt template~~ - Now emergent
* ~~##detectProceduralTopic()## requirement~~ - Factors generated for any topic when appropriate
* ~~KeyFactors only for procedural/legal topics~~ - Now optional for all topics

=== Implementation Status ===

|= Feature |= Status |= Notes
| Discovery in Understanding | Complete | Schema includes ##keyFactors## array
| Emergent factors | Complete | No forced template
| Optional hints | Complete | ##FH_KEYFACTOR_HINTS## env var provides suggestions (not enforced)
| Claim-to-factor mapping | Complete | ##keyFactorId## preserved in ##ClaimVerdict## (fixed 2026-01-06)
| Factor aggregation | Fixed | Aggregation logic should now find mapped claims (validation needed)
| Report display | Complete | Both question and article modes
| Contestation | Partial | Schema supports it but not fully implemented

----

== 7. Summary ==

|= Aspect |= Decision
| **What is KeyFactor?** | Evaluation dimension / decomposition question
| **When discovered?** | During Understanding phase
| **Required?** | No - optional, 0-N per analysis
| **Fixed template?** | No - emergent from thesis
| **Optional hints?** | Yes - ##FH_KEYFACTOR_HINTS## provides suggestions (not enforced)
| **Contestation?** | Attaches to KeyFactors
| **Scenario entity?** | Rejected - derivable from contestation
| **Relationship to Claims** | Parent-child (factor answered by claims)

----

== References ==

* FactHarbor POC1 Architecture Analysis (see local docs)
* [[Source Reliability System>>FactHarbor.Specification.Implementation.Source Reliability System.WebHome]]