= REST API Contract =

== 3.1 User Credit Tracking ==

**Endpoint:** GET /v1/user/credit

**Response:** 200 OK

{{{{
 "user_id": "user_abc123",
 "tier": "free",
 "credit_limit": 10.00,
 "credit_used": 7.42,
 "credit_remaining": 2.58,
 "reset_date": "2025-02-01T00:00:00Z",
 "cache_only_mode": false,
 "usage_stats": {
 "articles_analyzed": 67,
 "claims_from_cache": 189,
 "claims_newly_analyzed": 113,
 "cache_hit_rate": 0.626
 }
}
}}}

----



==== Stage 2 Output Schema: ClaimAnalysis ====

**Complete schema for each claim's analysis result:**

{{code language="json"}}
{
  "claim_id": "claim_abc123",
  "claim_text": "Biden won the 2020 election",
  "scenarios": [
    {
      "scenario_id": "scenario_1",
      "description": "Interpreting 'won' as Electoral College victory",
      "verdict": {
        "label": "TRUE",
        "confidence": 0.95,
        "explanation": "Joe Biden won 306 electoral votes vs Trump's 232"
      },
      "evidence": {
        "supporting": [
          {
            "text": "Biden certified with 306 electoral votes",
            "source_url": "https://www.archives.gov/electoral-college/2020",
            "source_title": "2020 Electoral College Results",
            "credibility_score": 0.98
          }
        ],
        "opposing": []
      }
    }
  ],
  "recommended_scenario": "scenario_1",
  "metadata": {
    "analysis_timestamp": "2024-12-24T18:00:00Z",
    "model_used": "claude-sonnet-4-5-20250929",
    "processing_time_seconds": 8.5
  }
}
{{/code}}

**Required Fields:**
* **claim_id**: Unique identifier matching Stage 1 output
* **claim_text**: The exact claim being analyzed
* **scenarios**: Array of interpretation scenarios (minimum 1)
 * **scenario_id**: Unique ID for this scenario
 * **description**: Clear interpretation of the claim
 * **verdict**: Verdict object with label, confidence, explanation
 * **evidence**: Supporting and opposing evidence arrays
* **recommended_scenario**: ID of the primary/recommended scenario
* **metadata**: Processing metadata (timestamp, model, timing)

**Optional Fields:**
* Additional context, warnings, or quality scores

**Minimum Viable Example:**

{{code language="json"}}
{
  "claim_id": "c1",
  "claim_text": "The sky is blue",
  "scenarios": [{
    "scenario_id": "s1",
    "description": "Under clear daytime conditions",
    "verdict": {"label": "TRUE", "confidence": 0.99, "explanation": "Rayleigh scattering"},
    "evidence": {"supporting": [], "opposing": []}
  }],
  "recommended_scenario": "s1",
  "metadata": {"analysis_timestamp": "2024-12-24T18:00:00Z"}
}
{{/code}}



==== Stage 3 Output Schema: ArticleAssessment ====

**Complete schema for holistic article-level assessment:**

{{code language="json"}}
{
  "article_id": "article_xyz789",
  "overall_assessment": {
    "credibility_score": 0.72,
    "risk_tier": "B",
    "summary": "Article contains mostly accurate claims with one disputed claim requiring expert review",
    "confidence": 0.85
  },
  "claim_aggregation": {
    "total_claims": 5,
    "verdict_distribution": {
      "TRUE": 3,
      "PARTIALLY_TRUE": 1,
      "DISPUTED": 1,
      "FALSE": 0,
      "UNSUPPORTED": 0,
      "UNVERIFIABLE": 0
    },
    "avg_confidence": 0.82
  },
  "contextual_factors": [
    {
      "factor": "Source credibility",
      "impact": "positive",
      "description": "Published by reputable news organization"
    },
    {
      "factor": "Claim interdependence",
      "impact": "neutral",
      "description": "Claims are independent; no logical chains"
    }
  ],
  "recommendations": {
    "publication_mode": "AI_GENERATED",
    "requires_review": false,
    "review_reason": null,
    "suggested_disclaimers": [
      "One claim (Claim 4) has conflicting expert opinions"
    ]
  },
  "metadata": {
    "holistic_timestamp": "2024-12-24T18:00:10Z",
    "model_used": "claude-sonnet-4-5-20250929",
    "processing_time_seconds": 4.2,
    "cache_used": false
  }
}
{{/code}}

**Required Fields:**
* **article_id**: Unique identifier for this article
* **overall_assessment**: Top-level assessment
 * **credibility_score**: 0.0-1.0 composite score
 * **risk_tier**: A, B, or C (per AKEL quality gates)
 * **summary**: Human-readable assessment
 * **confidence**: How confident the holistic assessment is
* **claim_aggregation**: Statistics across all claims
 * **total_claims**: Count of claims analyzed
 * **verdict_distribution**: Count per verdict label
 * **avg_confidence**: Average confidence across verdicts
* **contextual_factors**: Array of contextual considerations
* **recommendations**: Publication decision support
 * **publication_mode**: DRAFT_ONLY, AI_GENERATED, or HUMAN_REVIEWED
 * **requires_review**: Boolean flag
 * **suggested_disclaimers**: Array of disclaimer texts
* **metadata**: Processing metadata

**Minimum Viable Example:**

{{code language="json"}}
{
  "article_id": "a1",
  "overall_assessment": {
    "credibility_score": 0.95,
    "risk_tier": "C",
    "summary": "All claims verified as true",
    "confidence": 0.98
  },
  "claim_aggregation": {
    "total_claims": 1,
    "verdict_distribution": {"TRUE": 1},
    "avg_confidence": 0.99
  },
  "contextual_factors": [],
  "recommendations": {
    "publication_mode": "AI_GENERATED",
    "requires_review": false,
    "suggested_disclaimers": []
  },
  "metadata": {"holistic_timestamp": "2024-12-24T18:00:00Z"}
}
{{/code}}

== 3.2 Create Analysis Job (3-Stage) ==

**Endpoint:** POST /v1/analyze

=== Idempotency Support: ===

To prevent duplicate job creation on network retries, clients SHOULD include **either**:

* Header: ``Idempotency-Key: <client-generated-uuid>`` (preferred)
* OR body: ``client.request_id``

**Example request (header):**
{{code language="text"}}
POST /v1/analyze
Authorization: Bearer <API_KEY>
Idempotency-Key: 0f3c6c0e-2d2b-4b4a-9d6f-1a1f6b0c9f7e
Content-Type: application/json
{{/code}}

**Example request (body):**
{{code language="json"}}
{
  "input_url": "https://example.org/article",
  "options": { "max_claims": 5, "cache_preference": "prefer_cache" },
  "client": { "request_id": "0f3c6c0e-2d2b-4b4a-9d6f-1a1f6b0c9f7e" }
}
{{/code}}

**Server behavior:**
* Same idempotency key + same request body ⇒ return existing job (``200``) and include:
  ``idempotent=true`` and ``original_request_at``.
* Same key + different body ⇒ ``409`` with ``VALIDATION_ERROR`` describing the mismatch.

**Idempotency TTL:** 24 hours (minimum).

=== Request Body: ===

{{{{
 "input_type": "url",
 "input_url": "https://example.com/medical-report-01",
 "input_text": null,
 "options": {
 "browsing": "on",
 "depth": "standard",
 "max_claims": 5,

* **cache_preference** (optional): Cache usage preference
 * **Type:** string
 * **Enum:** {{code}}["prefer_cache", "allow_partial", "skip_cache"]{{/code}}
 * **Default:** {{code}}"prefer_cache"{{/code}}
 * **Semantics:**
  * {{code}}"prefer_cache"{{/code}}: Use full cache if available, otherwise run all stages
  * {{code}}"allow_partial"{{/code}}: Use cached Stage 2 results if available, rerun only Stage 3
  * {{code}}"skip_cache"{{/code}}: Always rerun all stages (ignore cache)
 * **Behavior:** When set to {{code}}"allow_partial"{{/code}} and Stage 2 cached results exist:
  * Stage 1 & 2 are skipped
  * Stage 3 (holistic assessment) runs fresh with cached claim analyses
  * Response includes {{code}}"cache_used": true{{/code}} and {{code}}"stages_cached": ["stage1", "stage2"]{{/code}}

 "scenarios_per_claim": 2,
 "max_evidence_per_scenario": 6,
 "context_aware_analysis": true
 },
 "client": {
 "request_id": "optional-client-tracking-id",
 "source_label": "optional"
 }
}
}}}

**Options:**

* browsing: on | off (retrieve web sources or just output queries)
* depth: standard | deep (evidence thoroughness)
* max_claims: 1-10 (default: **5** for cost control)
* scenarios_per_claim: 1-5 (default: **2** for cost control)
* max_evidence_per_scenario: 3-10 (default: **6**)
* context_aware_analysis: true | false (experimental)

**Response:** 202 Accepted

{{{{
 "job_id": "01J...ULID",
 "status": "QUEUED",
 "created_at": "2025-12-24T10:31:00Z",
 "estimated_cost": 0.114,
 "cost_breakdown": {
 "stage1_extraction": 0.003,
 "stage2_new_claims": 0.081,
 "stage2_cached_claims": 0.000,
 "stage3_holistic": 0.030
 },
 "cache_info": {
 "claims_to_extract": 5,
 "estimated_cache_hits": 4,
 "estimated_new_claims": 1
 },
 "links": {
 "self": "/v1/jobs/01J...ULID",
 "result": "/v1/jobs/01J...ULID/result",
 "report": "/v1/jobs/01J...ULID/report",
 "events": "/v1/jobs/01J...ULID/events"
 }
}
}}}

**Error Responses:**

402 Payment Required - Free tier limit reached, cache-only mode

{{{{
 "error": "credit_limit_reached",
 "message": "Monthly credit limit reached. Entering cache-only mode.",
 "cache_only_mode": true,
 "credit_remaining": 0.00,
 "reset_date": "2025-02-01T00:00:00Z",
 "action": "Resubmit with cache_preference=allow_partial for cached results"
}
}}}

----

**Navigation:** [[API & Schemas>>FactHarbor.Specification.POC.API-and-Schemas.WebHome]] | Prev: [[LLM Abstraction Layer>>FactHarbor.Specification.POC.API-and-Schemas.LLM Abstraction Layer.WebHome]] | Next: [[Data Schemas and Cache>>FactHarbor.Specification.POC.API-and-Schemas.Data Schemas and Cache.WebHome]]
