= Confidence Calibration =

{{info}}
**Developer Reference** — The 4-layer confidence calibration system that transforms raw LLM confidence into calibrated scores. Includes graduated recency penalty, low-source penalty, and confidence floor.

**Key File**: ##apps/web/src/lib/analyzer/confidence-calibration.ts##
{{/info}}

== Overview ==

Raw LLM confidence scores are unreliable — models tend to be overconfident or inconsistent across providers. FactHarbor applies a **4-layer calibration pipeline** that adjusts confidence based on evidence density, verdict band alignment, context consistency, and external penalties.

{{mermaid}}
flowchart LR
    RAW["Raw LLM<br/>Confidence"] --> D["Layer 1:<br/>Density Anchor"]
    D --> B["Layer 2:<br/>Band Snapping"]
    B --> V["Layer 3:<br/>Verdict Coupling"]
    V --> C["Layer 4:<br/>Context Consistency"]
    C --> PEN["Penalties:<br/>Recency + Low-Source"]
    PEN --> FLOOR["Floor: 10%<br/>minimum"]
    FLOOR --> FINAL["Calibrated<br/>Confidence"]

    style RAW fill:#ffcdd2,color:#000
    style FINAL fill:#c8e6c9,color:#000
    style PEN fill:#fff9c4,color:#000
{{/mermaid}}

//Raw LLM confidence (red) passes through 4 calibration layers, then penalty adjustments, and finally the confidence floor to produce calibrated confidence (green).//

== Layer 1: Density Anchor ==

Anchors confidence to the **density of supporting evidence**. More evidence = higher confidence baseline.

|= Evidence Count |= Confidence Anchor
| 0 sources | Floor (10%)
| 1 source, 1-2 facts | Max 40%
| 2 sources, 3-4 facts | Max 60%
| 3+ sources, 5+ facts | No cap (LLM confidence preserved)

**Rationale**: A claim supported by a single blog post should not have 95% confidence, regardless of what the LLM says.

== Layer 2: Band Snapping ==

Ensures confidence aligns with the verdict band. Prevents "HIGH confidence in UNVERIFIED" contradictions.

|= Verdict Band |= Max Confidence
| TRUE / FALSE | 100%
| MOSTLY TRUE / MOSTLY FALSE | 90%
| LEANING TRUE / LEANING FALSE | 80%
| MIXED | 70%
| UNVERIFIED | 50%

**Rationale**: If the system couldn't determine truth (UNVERIFIED), confidence in the verdict should reflect that uncertainty.

== Layer 3: Verdict Coupling ==

Couples confidence to the **distance from the band midpoint**. Verdicts near band boundaries get lower confidence than those squarely within a band.

{{code language="typescript"}}
// Example: truthPercentage = 72% is at the bottom of MOSTLY-TRUE (72-85%)
// Band midpoint = 78.5%
// Distance from midpoint = |72 - 78.5| / (85 - 72) = 0.5
// Confidence reduced proportionally to distance from midpoint
{{/code}}

**Rationale**: A verdict at 72% (just barely MOSTLY TRUE) should have lower confidence than one at 80% (solidly MOSTLY TRUE).

== Layer 4: Context Consistency ==

For multi-context analyses, checks whether verdict confidence is consistent across analysis contexts. Inconsistent contexts reduce overall confidence.

|= Scenario |= Adjustment
| Single context | No adjustment
| Multiple contexts, consistent verdicts | No adjustment
| Multiple contexts, divergent verdicts | Confidence reduced by divergence factor
| ##articleVerdictReliability = "low"## | Additional reduction

**Rationale**: When contexts answer different questions and produce wildly different verdicts, the overall confidence in the aggregated result should be lower.

== Post-Calibration Penalties ==

After the 4-layer calibration, two additional penalties may apply:

=== Graduated Recency Penalty (v2.11) ===

**Purpose**: Reduce confidence when time-sensitive claims lack recent evidence.

**Trigger**: Topic is recency-sensitive (via LLM ##temporalContext## or heuristic detection) AND no evidence found within the recency window.

**Formula**:
{{code}}
effectivePenalty = round(maxPenalty x staleness x volatility x volume)
{{/code}}

**Three independent factors**:

==== Factor 1: Staleness Curve ====

How far outside the recency window is the evidence?

|= Evidence Age |= Staleness Multiplier
| Within window (default: 6 months) | 0 (no penalty)
| Outside window, within 2x window | Linear ramp 0 → 1
| Beyond 2x window | 1.0 (capped)
| No dates found | 1.0 (full staleness)

==== Factor 2: Topic Volatility ====

How time-critical is the topic? Derived from ##temporalContext.granularity##:

|= Granularity |= Multiplier |= Example
| ##week## | 1.0 | Breaking news
| ##month## | 0.8 | Monthly-cycle topics
| ##year## | 0.4 | Institutional / annual
| ##none## | 0.2 | Enduring / structural
| //undefined// | 0.7 | Fallback when LLM didn't assess

==== Factor 3: Evidence Volume ====

More evidence (even if dated) attenuates the penalty:

|= Date Candidates |= Multiplier
| 0 | 1.0
| 1-10 | 0.9
| 11-25 | 0.7
| 26+ | 0.5

==== Example ====

Institutional topic (annual cycle):
* Evidence 14 months old, window = 6 months → staleness = 1.0 (capped)
* Granularity = "year" → volatility = 0.4
* 35 date candidates → volume = 0.5
* **Effective penalty = round(20 x 1.0 x 0.4 x 0.5) = 4 points** (vs. 20 flat)

**Backwards compatibility**: Set ##recencyGraduatedPenalty: false## to revert to flat binary penalty.

=== Low-Source Confidence Penalty ===

**Purpose**: Reduce confidence when evidence base is thin.

|= Parameter |= Default |= Description
| ##lowSourceThreshold## | 2 | Unique source count threshold
| ##lowSourceConfidencePenalty## | 15 | Flat penalty (points)

**Trigger**: Unique source count <= threshold.

=== Confidence Floor ===

After all penalties, confidence cannot drop below ##minConfidenceFloor## (default: **10%**).

== Configuration Reference ==

All settings are in UCM Pipeline Config:

{{code language="json"}}
{
  "recencyWindowMonths": 6,
  "recencyConfidencePenalty": 20,
  "recencyGraduatedPenalty": true,
  "lowSourceThreshold": 2,
  "lowSourceConfidencePenalty": 15,
  "minConfidenceFloor": 10
}
{{/code}}

|= Setting |= Default |= Rationale
| ##recencyWindowMonths## | 6 | Time-sensitive evidence window
| ##recencyConfidencePenalty## | 20 | Max penalty for recency gap
| ##recencyGraduatedPenalty## | true | Multi-factor graduated penalty
| ##lowSourceThreshold## | 2 | Source count for thin-evidence penalty
| ##lowSourceConfidencePenalty## | 15 | Penalty for thin evidence base
| ##minConfidenceFloor## | 10 | Absolute minimum confidence

== Confidence in Verdict Calculation ==

Calibrated confidence modulates the final truth percentage within each verdict band via ##truthFromBand()##:

{{code language="typescript"}}
function truthFromBand(band: "strong" | "partial" | "uncertain" | "refuted", confidence: number): number {
  const conf = normalizePercentage(confidence) / 100;
  switch (band) {
    case "strong":    return Math.round(72 + 28 * conf);  // 72-100%
    case "partial":   return Math.round(50 + 35 * conf);  // 50-85%
    case "uncertain": return Math.round(35 + 30 * conf);  // 35-65%
    case "refuted":   return Math.round(28 * (1 - conf)); // 0-28%
  }
}
{{/code}}

**Example — "strong" band with varying confidence**:
* High confidence (90%): 72 + 28x0.9 = **97% (TRUE)**
* Medium confidence (60%): 72 + 28x0.6 = **89% (TRUE)**
* Low confidence (30%): 72 + 28x0.3 = **80% (MOSTLY-TRUE)**

Same evidence band, but lower confidence pulls the verdict down within the band.

== MIXED vs UNVERIFIED ==

Confidence determines whether the 43-57% range is **MIXED** or **UNVERIFIED**:

{{code language="typescript"}}
const MIXED_CONFIDENCE_THRESHOLD = 60;

if (truthPercentage >= 43 && truthPercentage <= 57) {
  return confidence >= 60 ? "MIXED" : "UNVERIFIED";
}
{{/code}}

* **MIXED** (confidence >= 60%): Evidence on both sides, high confidence in mixed state
* **UNVERIFIED** (confidence < 60%): Insufficient evidence, low confidence

----

== Related Documentation ==

* [[Quality Gates>>FactHarbor.Specification.Architecture.Deep Dive.Quality Gates.WebHome]] — Gate 4 confidence tiers
* [[Calculations and Verdicts>>FactHarbor.Specification.Architecture.Deep Dive.Calculations and Verdicts.WebHome]] — Verdict calculation formulas
* [[Quality and Trust>>FactHarbor.Specification.Architecture.Quality and Trust.WebHome]] — Overview of confidence calibration in context

----

**Navigation:** [[Deep Dive Index>>FactHarbor.Specification.Architecture.Deep Dive.WebHome]] | Prev: [[Prompt Architecture>>FactHarbor.Specification.Architecture.Deep Dive.Prompt Architecture.WebHome]]
