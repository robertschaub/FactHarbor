= AKEL Pipeline =

The **AI Knowledge Extraction Layer (AKEL)** is FactHarbor's core analysis engine. It takes an article or claim as input and produces a structured verdict report through the ClaimAssessmentBoundary pipeline's 5-stage workflow: ##extractClaims → researchEvidence → clusterBoundaries → generateVerdicts → aggregateAssessment##.

== Pipeline Overview ==

{{include reference="FactHarbor.Product Development.Diagrams.AKEL Pipeline Detail.WebHome"/}}

=== Step-by-Step ===

**Stage 1: ##extractClaims##** — Extracts ##AtomicClaims## from user input.
* Two-pass LLM extraction: initial pass (##CLAIM_EXTRACTION_PASS1##) then consolidation and deduplication (##CLAIM_EXTRACTION_PASS2##)
* Sets ##passedFidelity## flag per claim (LLM-assessed verifiability)
* Applies **Gate 1** (Claim Validation): filters opinions, predictions, and non-verifiable claims
* Safety net: rescues highest-centrality claim if all claims would be filtered

**Stage 2: ##researchEvidence##** — Iteratively searches the web for evidence per claim.
* Generates targeted search queries per ##AtomicClaim## (##GENERATE_QUERIES##)
* Fetches and parses source content (HTML via cheerio, PDF via pdf2json)
* Classifies search result relevance and extracts ##EvidenceItems## from source content
* Applies evidence quality filtering (probative value, deduplication, provenance)
* Iterates per ##ClaimAssessmentBoundary## (up to 3 rounds) until research complete or token budget exhausted (750K tokens)

**Stage 3: ##clusterBoundaries##** — Groups evidence into ##ClaimAssessmentBoundaries##.
* LLM clusters compatible ##EvidenceScopes## into evidence groupings (##BOUNDARY_CLUSTERING##)
* Boundaries emerge from evidence — not predefined analytical templates

**Stage 4: ##generateVerdicts##** — Generates per-claim verdicts via structured debate.
* Advocate → Challenger → Reconciliation pattern (3 Sonnet calls per boundary)
* Advisory validation: grounding check and direction check (Haiku, non-blocking)
* Produces ##CBClaimVerdicts## with confidence scores and evidence citations

**Stage 5: ##aggregateAssessment##** — Aggregates verdicts and produces the final result.
* Applies **Gate 4** (Confidence Assessment): flags low-confidence verdicts
* Weighted aggregation of ##CBClaimVerdicts## (centrality, harm potential, confidence, triangulation)
* Generates verdict narrative and final ##AnalysisResult##

== Pipeline Variants ==

FactHarbor supports two pipeline variants. The **ClaimAssessmentBoundary** pipeline is the comprehensive default; the **monolithic dynamic** variant is a fast, lower-cost alternative.

{{mermaid}}
flowchart LR
    INPUT["User Input"] --> DISPATCH{{"Pipeline\nDispatch"}}

    DISPATCH -->|"claimboundary\n(default)"| CB["ClaimAssessmentBoundary\n5-stage workflow\nFull quality gates"]
    DISPATCH -->|"monolithic_dynamic"| DYN["Monolithic Dynamic\nSingle LLM call\nFlexible output"]

    CB --> RESULT["AnalysisResult\nJSON"]
    DYN --> RESULT

    style CB fill:#c8e6c9,stroke:#2e7d32,color:#000
    style DYN fill:#f3e5f5,stroke:#6a1b9a,color:#000
{{/mermaid}}

//Both variants produce an AnalysisResult JSON output. The ClaimAssessmentBoundary pipeline is the default and most capable; the monolithic dynamic variant trades depth for speed and flexibility.//

|= Variant |= Approach |= Quality |= Speed |= Use Case
| **ClaimAssessmentBoundary** | 5-stage workflow (extract → research → cluster → verdict → aggregate) with iterative research, quality gates, evidence filtering | Highest | Thorough (multiple LLM calls) | Production analysis
| **Monolithic Dynamic** | Single LLM tool-loop call, flexible output | Streamlined | Fastest | Fast analysis, second opinion

== Shared Analysis Modules ==

All pipeline variants share a common set of analysis modules. This ensures consistency in verdict calculations, evidence quality, and source reliability across pipelines.

{{include reference="FactHarbor.Product Development.Diagrams.AKEL Shared Modules.WebHome"/}}

|= Module |= Used By |= Purpose
| ##aggregation.ts## | CB | Verdict weighting by centrality/harm/confidence/triangulation, contestation weight reduction
| ##claim-decomposition.ts## | CB | Claim text parsing and normalisation
| ##evidence-filter.ts## | CB | Probative value filtering, false positive rate calculation
| ##quality-gates.ts## | CB | Gate 1 (claim fidelity + specificity) and Gate 4 (verdict confidence)
| ##source-reliability.ts## | CB, Dyn | LLM-based source credibility evaluation with SQLite cache
| ##truth-scale.ts## | CB, Dyn | Percentage-to-verdict label mapping (7-point scale)
| ##budgets.ts## | CB, Dyn | Token and cost budget tracking and enforcement

== Budget Controls ==

The ClaimAssessmentBoundary pipeline enforces budgets to prevent runaway LLM costs:

|= Budget |= Default |= Purpose
| Max research iterations | 3 per boundary | Limits research rounds per ClaimAssessmentBoundary
| Max total tokens | 750,000 | Caps total LLM token consumption across all stages
| Max boundaries | UCM-configurable | Hard limit on ClaimAssessmentBoundaries processed in parallel

== Deep Dives ==

For detailed implementation references:
* [[Pipeline Variants>>FactHarbor.Product Development.Specification.Architecture.Deep Dive.Pipeline Variants.WebHome]] — CB pipeline (5 stages) and Monolithic Dynamic: invariants, shared primitives, result model
* [[Quality Gates>>FactHarbor.Product Development.Specification.Architecture.Deep Dive.Quality Gates.WebHome]] — Gate 1 (claim fidelity) and Gate 4 (verdict confidence) criteria, configuration

----

**Navigation:** [[Architecture>>FactHarbor.Product Development.Specification.Architecture.WebHome]] | Prev: [[System Design>>FactHarbor.Product Development.Specification.Architecture.System Design.WebHome]] | Next: [[Data Model>>FactHarbor.Product Development.Specification.Architecture.Data Model.WebHome]]
