= Storage and Configuration =

FactHarbor uses a three-database architecture with SQLite and a Unified Config Management (UCM) system for runtime configuration. This page covers the storage design, caching strategy, and evolution roadmap.

== Three-Database Architecture ==

{{mermaid}}
flowchart TB
    subgraph NextJS["Next.js Web App"]
        PIPELINE["AKEL Pipeline"]
        CONFIG_SVC["Config Storage\n(config-storage.ts)"]
        SR_SVC["SR Cache\n(source-reliability-cache.ts)"]
    end

    subgraph DotNet[".NET API"]
        EF["Entity Framework\nCore"]
    end

    FH_DB[("factharbor.db\nJobs, events, metrics\n(.NET EF Core)")]
    CONFIG_DB[("config.db\nUCM configuration\n(Next.js better-sqlite3)")]
    SR_DB[("source-reliability.db\nSource credibility cache\n(Next.js better-sqlite3)")]

    EF --> FH_DB
    CONFIG_SVC --> CONFIG_DB
    SR_SVC --> SR_DB
    PIPELINE -->|"via REST API"| EF

    style NextJS fill:#e8f5e9,stroke:#2e7d32,color:#000
    style DotNet fill:#e3f2fd,stroke:#1565c0,color:#000
{{/mermaid}}

//Each database has a single owner: factharbor.db is managed by the .NET API, config.db and source-reliability.db by the Next.js app. This prevents cross-service write conflicts and keeps each database focused on one concern.//

|= Database |= Owner |= Technology |= Key Tables |= Purpose
| ##factharbor.db## | .NET API | Entity Framework Core | ##Jobs##, ##JobEvents##, ##AnalysisMetrics## | Job persistence, event logging, analysis results (JSON blob)
| ##config.db## | Next.js | better-sqlite3 | ##config_blobs##, ##config_active##, ##config_usage## | UCM configuration with versioning and content-addressing
| ##source-reliability.db## | Next.js | better-sqlite3 | ##source_reliability## | Source credibility evaluation cache (90-day TTL)

=== Current Caching ===

|= What |= Mechanism |= TTL |= Status
| Source reliability scores | SQLite + in-memory ##Map## (batch prefetch) | 90 days (configurable) | Implemented
| UCM config values | In-memory ##Map## with TTL-based expiry | 60 seconds | Implemented
| URL content (fetched pages) | Not cached | N/A | Planned (Alpha)
| Claim-level analysis results | Not cached | N/A | Planned (Alpha)

== Unified Config Management (UCM) ==

UCM provides runtime configuration management with schema validation, version tracking, and hot-reload support.

{{mermaid}}
flowchart TB
    subgraph Admin["Admin UI"]
        EDITOR["Config Editor\n(JSON / Form view)"]
        HISTORY["Version History\n& Compare"]
    end

    subgraph Types["Configuration Types"]
        PIPELINE["Pipeline Config"]
        SEARCH["Search Config"]
        CALC["Calculation Config"]
        SR["Source Reliability"]
        PROMPTS["Prompt Templates"]
    end

    subgraph Validation["Validation"]
        ZOD["Zod Schema\nValidation"]
        CANON["SHA-256\nContent Hash"]
    end

    subgraph Storage["SQLite (config.db)"]
        BLOBS["config_blobs\n(immutable, content-addressed)"]
        ACTIVE["config_active\n(activation pointers)"]
        SNAPSHOTS["job_config_snapshots\n(per-job tracking)"]
    end

    subgraph Runtime["Runtime"]
        CACHE["In-memory Map\n(60s TTL)"]
        JOB["Analysis Job\n(reads snapshot)"]
    end

    EDITOR --> Types
    Types --> ZOD
    ZOD -->|"valid"| CANON
    CANON --> BLOBS
    BLOBS --> ACTIVE
    ACTIVE --> SNAPSHOTS
    ACTIVE --> CACHE
    CACHE --> JOB
    HISTORY --> BLOBS

    style Admin fill:#f3e5f5,stroke:#6a1b9a,color:#000
    style Validation fill:#fff9c4,stroke:#f9a825,color:#000
    style Storage fill:#e3f2fd,stroke:#1565c0,color:#000
    style Runtime fill:#e8f5e9,stroke:#2e7d32,color:#000
{{/mermaid}}

//Admin edits a config in the UI. It passes through Zod schema validation, gets content-addressed (SHA-256), and stored as an immutable blob. An activation pointer selects the current version. Each analysis job snapshots the active config, ensuring reproducible results.//

=== Configuration Types ===

|= Type |= Default File |= Schema |= Key Settings
| **Pipeline** | ##configs/pipeline.default.json## | ##PipelineConfig## | LLM provider, model tiering, analysis mode, iteration limits, token budgets
| **Search** | ##configs/search.default.json## | ##SearchConfig## | Search provider, max results, domain whitelist/blacklist
| **Calculation** | ##configs/calculation.default.json## | ##CalcConfig## | Verdict bands, confidence thresholds, weighting parameters
| **Source Reliability** | ##configs/sr.default.json## | ##SRConfig## | Evaluation prompt, cache TTL, consensus scoring
| **Prompts** | ##prompts/*.prompt.md## | ##PromptConfig## | Pipeline step prompt templates (markdown)

=== Source of Truth Hierarchy ===

1. **Runtime**: Database (what the app actually uses)
1. **Defaults**: JSON files in ##apps/web/configs/##
1. **Fallback**: Code constants in ##config-schemas.ts##

=== Key UCM Features ===

* **Content-addressed storage** — Config blobs identified by SHA-256 hash; same content = same hash (deduplication)
* **Immutable history** — All past versions retained; any version can be re-activated
* **Per-job snapshots** — Each analysis job records which config version it used (auditability)
* **Hot-reload** — Config changes take effect within 60 seconds (cache TTL)
* **Rollback** — One-click revert to any previous version via Admin UI
* **Validation** — Zod schemas enforce type safety and value constraints before saving
* **Import/Export** — Configs can be imported from and exported to JSON files

== Storage Evolution Roadmap ==

{{mermaid}}
flowchart LR
    subgraph P1["POC (Current)"]
        S1["3x SQLite\n+ in-memory Map"]
    end

    subgraph P2["Alpha"]
        S2["Add URL cache\nAdd claim cache\n(still SQLite)"]
    end

    subgraph P3["Beta"]
        S3["PostgreSQL\nfor factharbor.db\n(user accounts, search)"]
    end

    subgraph P4["V1.0+"]
        S4["Redis IF multi-instance\nVector DB IF Shadow Mode\nS3 IF >50GB"]
    end

    P1 --> P2 --> P3 --> P4

    style P1 fill:#c8e6c9,stroke:#2e7d32,color:#000
    style P2 fill:#e8f5e9,stroke:#2e7d32,color:#000
    style P3 fill:#e3f2fd,stroke:#1565c0,color:#000
    style P4 fill:#f3e5f5,stroke:#6a1b9a,color:#000
{{/mermaid}}

//Storage evolves incrementally: expand SQLite caching first (Alpha), migrate to PostgreSQL when user accounts and search are needed (Beta), add Redis/Vector DB/S3 only when specific triggers are met (V1.0+).//

=== Technology Decisions ===

|= Technology |= Decision |= Trigger for Adoption
| **SQLite caching** | Evaluate (Alpha) | URL content and claim-level caching reduce cost and latency
| **PostgreSQL** | Evaluate (Beta) | User accounts, full-text search, cross-analysis queries
| **Redis** | Defer | Multiple application instances needing shared cache
| **Vector DB** | Defer | Shadow Mode data proves near-duplicate detection needs exceed text hashing
| **S3** | Defer | Storage exceeds ~50GB

----

**Navigation:** [[Architecture>>FactHarbor.Product Development.Specification.Architecture.WebHome]] | Prev: [[External Dependencies>>FactHarbor.Product Development.Specification.Architecture.External Dependencies.WebHome]] | Next: [[Quality and Trust>>FactHarbor.Product Development.Specification.Architecture.Quality and Trust.WebHome]]
