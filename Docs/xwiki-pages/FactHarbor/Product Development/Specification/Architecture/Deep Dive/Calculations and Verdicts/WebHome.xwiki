= Calculations and Verdicts =

{{info}}
**Developer Reference** — Verdict scale, counter-evidence handling, aggregation hierarchy, weighting formulas, and special-case guards that produce FactHarbor's final verdicts.

**Key Files**: ##apps/web/src/lib/analyzer/aggregation.ts##, ##apps/web/src/lib/analyzer/truth-scale.ts##, ##apps/web/src/lib/analyzer/claimboundary-pipeline.ts##, ##apps/web/src/lib/analyzer/source-reliability.ts##
{{/info}}

**Version**: 2.11.0
**Status**: Operational

----

== 1. Verdict Scale (7-Point System) ==

FactHarbor uses a symmetric 7-point scale with truth percentages from 0-100%. The 43-57% range distinguishes between **MIXED** (high confidence, evidence on both sides) and **UNVERIFIED** (low confidence, insufficient evidence).

|= Verdict |= Range |= Confidence |= Description
| **TRUE** | 86-100% | - | Strong support, no credible counter-evidence
| **MOSTLY-TRUE** | 72-85% | - | Mostly supported, minor gaps
| **LEANING-TRUE** | 58-71% | - | Mixed evidence, leans positive
| **MIXED** | 43-57% | >= 40% | Evidence on both sides, roughly equal
| **UNVERIFIED** | 43-57% | < 40% | Insufficient evidence to judge
| **LEANING-FALSE** | 29-42% | - | More counter-evidence than support
| **MOSTLY-FALSE** | 15-28% | - | Strong counter-evidence
| **FALSE** | 0-14% | - | Direct contradiction

=== 1.1 MIXED vs UNVERIFIED ===

* **MIXED** (blue in UI): Substantial evidence exists, but is roughly equal on both sides. High confidence in the mixed state.
* **UNVERIFIED** (orange in UI): Not enough evidence to make any judgement. Low confidence due to insufficient information.

=== 1.2 percentageToClaimVerdict ===

**File**: ##apps/web/src/lib/analyzer/truth-scale.ts## (line 138)

Band thresholds and the ##mixedConfidenceThreshold## are UCM-configurable via ##CalcConfig.verdictBands##.

{{code language="typescript"}}
// Simplified — actual signature takes VerdictBandConfig + mixedConfidenceThreshold from UCM
function percentageToClaimVerdict(truthPercentage: number, confidence?: number): ClaimVerdict7Point {
  if (truthPercentage >= 86) return "TRUE";
  if (truthPercentage >= 72) return "MOSTLY-TRUE";
  if (truthPercentage >= 58) return "LEANING-TRUE";
  if (truthPercentage >= 43) {
    const conf = confidence !== undefined ? normalizePercentage(confidence) : 0;
    return conf >= mixedConfidenceThreshold ? "MIXED" : "UNVERIFIED";
  }
  if (truthPercentage >= 29) return "LEANING-FALSE";
  if (truthPercentage >= 15) return "MOSTLY-FALSE";
  return "FALSE";
}
{{/code}}

=== 1.3 truthFromBand ===

Converts confidence-adjusted bands to truth percentages:

{{code language="typescript"}}
function truthFromBand(band: "strong" | "partial" | "uncertain" | "refuted", confidence: number): number {
  const conf = normalizePercentage(confidence) / 100;
  switch (band) {
    case "strong":    return Math.round(72 + 28 * conf);  // 72-100%
    case "partial":   return Math.round(50 + 35 * conf);  // 50-85%
    case "uncertain": return Math.round(35 + 30 * conf);  // 35-65%
    case "refuted":   return Math.round(28 * (1 - conf)); // 0-28%
  }
}
{{/code}}

**Example ("strong" band with varying confidence)**:

|= Confidence |= Calculation |= Result |= Verdict
| High (90%) | 72 + 28 x 0.9 | 97% | **TRUE**
| Medium (60%) | 72 + 28 x 0.6 | 89% | **TRUE**
| Low (30%) | 72 + 28 x 0.3 | 80% | **MOSTLY-TRUE**

Same evidence band, but lower confidence pulls the verdict down within the band.

----

== 2. Counter-Evidence Handling ==

Counter-evidence is distinguished from mere contestation and influences verdict calculations. The v2.8 system separates **DOUBTED** (political criticism without documented evidence) from **CONTESTED** (actual documented counter-evidence).

=== 2.1 Doubted vs Contested ===

{{include reference="FactHarbor.Product Development.Diagrams.Doubted vs Contested Flow.WebHome"/}}

//Orange = doubted (opinion only). Yellow = disputed evidence. Red = established counter-evidence. Green = full weight preserved.//

**Key Distinction:**

* **DOUBTED** = Political criticism, rhetoric, accusations WITHOUT documented evidence -> Full weight (claim remains credible)
* **CONTESTED** = Has actual documented counter-evidence -> Reduced weight (genuine uncertainty)

**Implementation (v2.8):**

* ##detectClaimContestation()## in ##aggregation.ts## -- Claim-level contestation detection (CB pipeline)
* Contestation classification is LLM-derived (##factualBasis## field, set during verdict generation); weight reduction applied via ##getClaimWeight()## in ##aggregation.ts##

=== 2.2 Evidence Item Categorization ===

**File**: ##apps/web/src/lib/analyzer/types.ts## (##EvidenceItem## interface)

Evidence items are categorized during extraction:

|= Category |= Description
| ##"evidence"## | Supporting evidence
| ##"criticism"## | Counter-evidence or opposing views
| ##"expert_quote"## | Expert testimony
| ##"statistic"## | Numerical data
| ##"legal_provision"## | Legal framework
| ##"event"## | Factual events

=== 2.3 Contestation Fields ===

{{code language="typescript"}}
interface EvidenceItem {
  category: "legal_provision" | "evidence" | "expert_quote" | "statistic" | "event" | "criticism";
  isContestedClaim?: boolean;  // True if this evidence item contests a claim
  claimSource?: string;         // Who makes the contested claim
}
{{/code}}

=== 2.4 Evidence-Based Contestation Weight Reduction ===

**File**: ##apps/web/src/lib/analyzer/aggregation.ts## (##getClaimWeight()##)

Contestation with documented evidence reduces a claim's **weight** in the overall verdict (v2.9.0 — changed from point deductions to weight multipliers to avoid double-penalising contested claims whose ##truthPercentage## already reflects counter-evidence):

{{code language="typescript"}}
if (claim.isContested) {
  const ctw = weights?.contestationWeights ?? { established: 0.5, disputed: 0.7, opinion: 1.0 };
  const basis = claim.factualBasis || "unknown";
  if (basis === "established") weight *= ctw.established;      // default 0.5x
  else if (basis === "disputed") weight *= ctw.disputed;       // default 0.7x
  // "opinion", "unknown" = doubted only → full weight
}
{{/code}}

|= factualBasis |= Weight Multiplier |= Rationale
| ##"established"## | 0.5x (default) | Strong documented counter-evidence reduces influence
| ##"disputed"## | 0.7x (default) | Some documented counter-evidence moderately reduces influence
| ##"opinion"## | 1.0x | Rhetoric only, no documented evidence → full weight
| ##"unknown"## | 1.0x | No evidence of contestation → full weight

All multipliers are UCM-configurable via ##CalcConfig.aggregation.contestationWeights##.

----

== 3. Aggregation Hierarchy ==

The aggregation system produces the final verdict by rolling up from individual evidence items through four levels to the overall answer.

{{mermaid}}
graph TD
    Evidence["Evidence Items<br/>(per source)"] --> ClaimVerdicts["AtomicClaim Verdicts<br/>(per claim — Stage 4 LLM debate:<br/>Advocate → Challenger → Reconciliation)"]
    ClaimVerdicts --> WeightCalc["Weight Calculation<br/>━━━━━━━━━━━━━<br/>centrality: high=3.0x / med=2.0x / low=1.0x<br/>harmPotential: high=1.5x<br/>confidence: 0–1 factor<br/>triangulation + derivative adjustments<br/>contestation: established=0.5x / disputed=0.7x"]
    WeightCalc --> OverallAnswer["Overall Answer<br/>(Stage 5: aggregateAssessment)"]
    OverallAnswer --> ArticleVerdict["Article Verdict<br/>(verdict label + narrative)"]

    style Evidence fill:#e8f5e9,color:#000
    style ClaimVerdicts fill:#c8e6c9,color:#000
    style WeightCalc fill:#e3f2fd,color:#000
    style OverallAnswer fill:#fff3e0,color:#000
    style ArticleVerdict fill:#f3e5f5,color:#000
{{/mermaid}}

//Green = evidence and claim verdicts. Blue = weight calculation (Stage 5). Orange = overall answer. Purple = article verdict (label + narrative).//

=== 3.1 Weight Calculation ===

**Function**: ##getClaimWeight()## in ##aggregation.ts## (v3.1) + inline in ##aggregateAssessment()## for final triangulation/derivative factors.

All multipliers are UCM-configurable via ##CalcConfig.aggregation##.

{{code language="typescript"}}
// Base weight formula (v3.1 — aggregateAssessment, Stage 5):
// finalWeight = centralityWeight × harmWeight × confidenceFactor
//             × (1 + triangulationFactor) × derivativeFactor
//
// + contestation reduction applied via getClaimWeight() in aggregation.ts

// thesisRelevance guard — tangential/irrelevant claims excluded
if (claim.thesisRelevance && claim.thesisRelevance !== "direct") return 0;

const centralityWeight =
  centrality === "high"   ? cw.high   :   // default 3.0
  centrality === "medium" ? cw.medium :   // default 2.0
                            cw.low;       // default 1.0

const harmWeight = harmLevel === "high" ? 1.5 : 1.0;  // UCM-configurable
const confidenceFactor = verdict.confidence / 100;
{{/code}}

|= Factor |= Default |= Condition
| Centrality — high | 3.0x | Claim is ##centrality: "high"##
| Centrality — medium | 2.0x | Claim is ##centrality: "medium"##
| Centrality — low | 1.0x | Claim is ##centrality: "low"## (or unset)
| ##thesisRelevance## ≠ ##"direct"## | 0x | Tangential/irrelevant claims excluded entirely
| Harm potential — high | 1.5x | ##harmPotential: "high"## (death, injury, safety claims)
| Confidence | 0–1 factor | ##verdict.confidence / 100## (e.g. 80% confidence → 0.8x)
| Triangulation | 1 + factor | Multi-source corroboration bonus (UCM-configurable)
| Derivative | 0.5x–1.0x | Derivative/secondary claims down-weighted
| Contested (established) | 0.5x | Counter-evidence is ##"established"## (UCM-configurable)
| Contested (disputed) | 0.7x | Counter-evidence is ##"disputed"## (UCM-configurable)
| Doubted (opinion/unknown) | 1.0x | No documented counter-evidence → full weight

=== 3.2 Level 1: Claim Verdicts ===

**Source**: LLM verdict generation + source reliability weighting (see [[Source Reliability>>FactHarbor.Product Development.Specification.Architecture.Deep Dive.Source Reliability.WebHome]]).

Source reliability adjusts verdicts based on the credibility of evidence sources. See Section 7 below for the full formula.

=== 3.3 Level 2: Weighted Average Computation ===

**File**: ##apps/web/src/lib/analyzer/claimboundary-pipeline.ts## (##aggregateAssessment()##, Stage 5)

The CB pipeline has no "Key Factor" intermediate layer. All ##AtomicClaim## verdicts are aggregated directly using the weighted formula from §3.1. Counter-claims have their truth percentage inverted before aggregation:

{{code language="typescript"}}
// Counter-claims evaluate the OPPOSITE position — invert their truth%
// If counter-claim is TRUE (85%), it means the user's thesis is FALSE (15%)
const effectiveTruthPct = claim.isCounterClaim
  ? 100 - claim.truthPercentage
  : claim.truthPercentage;

// Weighted sum across all direct AtomicClaims
const weightedTruthPct = Σ(effectiveTruthPct × weight) / Σ(weight);
{{/code}}

=== 3.4 Level 3: Overall Verdict ===

**File**: ##apps/web/src/lib/analyzer/claimboundary-pipeline.ts## (##aggregateAssessment()##, Stage 5) + ##apps/web/src/lib/analyzer/truth-scale.ts## (##percentageToArticleVerdict()##)

The weighted truth percentage from Level 2 is mapped to a verdict label and then enriched with a narrative:

{{code language="typescript"}}
// Map weighted truth% to 7-point verdict label
const verdictLabel = percentageToArticleVerdict(
  weightedTruthPercentage,
  weightedConfidence,
  undefined,
  mixedConfidenceThreshold,  // UCM-configurable
);

// Generate human-readable narrative (VERDICT_NARRATIVE prompt — Sonnet)
const verdictNarrative = await generateVerdictNarrative(
  weightedTruthPercentage, verdictLabel, weightedConfidence,
  claimVerdicts, boundaries, ...
);
{{/code}}

ClaimAssessmentBoundaries group related claims during research (Stage 3) and drive separate LLM debates (Stage 4), but the final aggregation in Stage 5 operates over all ##CBClaimVerdict[]## directly — there is no per-boundary averaging step before the overall verdict.

=== 3.5 Multi-Boundary Caveat ===

When a claim spans multiple distinct ##ClaimAssessmentBoundaries## (e.g., "Legal fairness in period A" and "Scientific validity in period B"), the weighted average across all claim verdicts may produce a less intuitive overall number than individual boundary-level answers would. The ##articleVerdictReliability## flag and ##articleVerdictReason## field in the output signal this to the UI when boundaries have significantly divergent verdicts. See [[Context Detection>>FactHarbor.Product Development.Specification.Architecture.Deep Dive.Context Detection.WebHome]] for details on multi-boundary scenarios.

----

== 4. Near-Duplicate Claim Handling ==

=== 4.1 Problem ===

If the LLM generates multiple claims expressing the same idea, both would influence the overall verdict, effectively double-counting the same evidence.

=== 4.2 Solution: LLM-Based Claim Deduplication ===

In the CB pipeline, near-duplicate claims are deduplicated **upstream** by the LLM during ##CLAIM_EXTRACTION_PASS2## (see [[Prompt Architecture>>FactHarbor.Product Development.Specification.Architecture.Deep Dive.Prompt Architecture.WebHome]]). The LLM consolidates semantically equivalent claims before they enter the aggregation stage, eliminating the need for downstream Jaccard-similarity clustering.

The deterministic ##dedupeWeightedAverageTruth()## function from the prior Orchestrated pipeline is not present in the CB pipeline. If near-duplicate claims survive extraction, the weighted average in Stage 5 (§3.3) dilutes their combined influence through confidence-based weighting.

**Current de-duplication point**: ##CLAIM_EXTRACTION_PASS2## LLM call in Stage 1 (##extractClaims##).

=== 4.3 Example ===

{{code}}
Cluster 1: [Claim A (85%), Claim B (82%), Claim C (80%)]
  - Claim A: 85% x 1.0  = 85.0
  - Claim B: 82% x 0.25 = 20.5
  - Claim C: 80% x 0.25 = 20.0
  - Total weight: 1.5
  - Contribution: 125.5 / 1.5 = 83.7%

Cluster 2: [Claim D (90%)]
  - Claim D: 90% x 1.0 = 90.0
  - Total weight: 1.0
  - Contribution: 90.0 / 1.0 = 90.0%

Overall: (83.7 + 90.0) / 2 = 86.9%
{{/code}}

**UI impact**: All claims are still displayed. De-duplication only affects aggregation calculations, not visibility.

----

== 5. Dependency Handling ==

**Field**: ##dependencyFailed## on ##CBClaimVerdict## (##apps/web/src/lib/analyzer/types.ts##, line 477)

Claims can depend on other claims (e.g., "timing" depends on "attribution"). If a dependency is false, the dependent claim is excluded from aggregation to avoid double-counting the false prerequisite.

{{code language="typescript"}}
// Check if any dependency is false (truthPercentage < 43%)
const failedDeps = dependencies.filter((depId: string) => {
  const depVerdict = verdictMap.get(depId);
  return depVerdict && depVerdict.truthPercentage < 43;
});

if (failedDeps.length > 0) {
  verdict.dependencyFailed = true;
  verdict.failedDependencies = failedDeps;
}
{{/code}}

**Threshold**: ##truthPercentage < 43%## (below the LEANING-FALSE / UNVERIFIED boundary).

Claims with ##dependencyFailed = true## are excluded from aggregation (independent verdicts only).

----

== 6. Pseudoscience Escalation ==

{{warning}}
**Orchestrated pipeline only — not implemented in the CB pipeline.** The ##escalatePseudoscienceVerdict()## function and associated keyword-pattern logic existed in ##orchestrated.ts##, which was removed in v2.11.0.
{{/warning}}

In the ClaimAssessmentBoundary pipeline, pseudoscience claims are handled through LLM reasoning in the Advocate/Challenger/Reconciliation debate (Stage 4). The Challenger role is prompted to surface scientific consensus and credible counter-evidence, which naturally drives pseudoscience claims toward low truth percentages without requiring hardcoded keyword lists or deterministic escalation logic.

----

== 7. Benchmark Guard (Proportionality Claims) ==

{{warning}}
**Orchestrated pipeline only — not implemented in the CB pipeline.** The ##hasBenchmarkEvidence## heuristic and ##EVALUATIVE_OUTCOME_RE## regex existed in ##orchestrated.ts##, which was removed in v2.11.0.
{{/warning}}

In the ClaimAssessmentBoundary pipeline, proportionality claims are handled through the ##VERDICT_RECONCILIATION## LLM step (Stage 4). The reconciliation prompt instructs the model to flag insufficient comparative evidence and to reflect that uncertainty in the ##confidence## score, rather than deterministically forcing ##truthPct = 50##. This approach generalises across languages and domains without requiring hardcoded numeric patterns or regex matching.

----

== 8. Source Reliability Weighting ==

**Version**: v2.11.0+
**Files**: ##apps/web/src/lib/analyzer/source-reliability.ts##, ##apps/web/src/lib/analyzer/claimboundary-pipeline.ts##

Source reliability scores influence verdict calculations by adjusting truth percentages based on the credibility of evidence sources. For full details on the reliability evaluation system, see [[Source Reliability>>FactHarbor.Product Development.Specification.Architecture.Deep Dive.Source Reliability.WebHome]].

=== 8.1 Score = Weight ===

With the 7-band credibility scale, the LLM score directly represents reliability and is used as-is for verdict weighting:

{{code language="typescript"}}
function calculateEffectiveWeight(data: SourceReliabilityData): number {
  // Simple: score IS the weight
  // Confidence already filtered out low-quality evaluations (threshold gate)
  return data.score;
}
{{/code}}

|= Component |= Purpose
| **Score** | LLM-evaluated reliability (7-band scale, 0.0-1.0) -- used directly as weight
| **Confidence** | Quality gate (threshold: 65%) -- scores below threshold are rejected
| **Consensus** | Multi-model agreement (Claude + GPT-4 must agree within 15%)

=== 8.2 Verdict Adjustment Formula ===

{{code language="typescript"}}
// Average effective weight across all sources for a verdict
const avgWeight = sources.map(s => calculateEffectiveWeight(s))
  .reduce((a, b) => a + b) / sources.length;

// Pull verdict toward neutral (50) based on reliability
adjustedTruth = Math.round(50 + (originalTruth - 50) * avgWeight);

// Scale confidence by reliability
adjustedConfidence = Math.round(originalConfidence * (0.5 + avgWeight / 2));
{{/code}}

=== 8.3 Impact Examples ===

**High Reliability Source (Reuters, 95% score)**

{{code}}
Original verdict: 85% (MOSTLY-TRUE)
Adjusted: 50 + (85 - 50) x 0.95 = 83.3% -> 83% (MOSTLY-TRUE)
Impact: Verdict mostly preserved
{{/code}}

**Unknown Source (50% score -- neutral default)**

{{code}}
Original verdict: 85% (MOSTLY-TRUE)
Adjusted: 50 + (85 - 50) x 0.50 = 67.5% -> 68% (LEANING-TRUE)
Impact: Strong pull toward neutral (appropriate skepticism)
{{/code}}

**Low Reliability Source (27% score)**

{{code}}
Original verdict: 85% (MOSTLY-TRUE)
Adjusted: 50 + (85 - 50) x 0.27 = 59.5% -> 60% (LEANING-TRUE)
Impact: Strong pull toward neutral (unreliable source)
{{/code}}

**Multi-Source Averaging**

{{code}}
Verdict evidence from:
  - reuters.com:       95% score
  - bild.de:           44% score
  - unknown-blog.xyz:  50% score (default)

Average weight: (95 + 44 + 50) / 3 = 63%

Original: 85% -> Adjusted: 50 + (85 - 50) x 0.63 = 72% (LEANING-TRUE)
{{/code}}

=== 8.4 Unknown Source Handling ===

Sources not in the reliability cache are assigned ##defaultScore = 0.5## (symmetric scale centre), resulting in 50% weight (neutral). This applies appropriate skepticism without completely discounting evidence.

----

== 9. Related Documentation ==

* [[Quality Gates>>FactHarbor.Product Development.Specification.Architecture.Deep Dive.Quality Gates.WebHome]] -- Gate 1 (claim validation) and Gate 4 (confidence assessment)
* [[Source Reliability>>FactHarbor.Product Development.Specification.Architecture.Deep Dive.Source Reliability.WebHome]] -- Full source reliability evaluation system
* [[Context Detection>>FactHarbor.Product Development.Specification.Architecture.Deep Dive.Context Detection.WebHome]] -- ClaimAssessmentBoundary clustering, multi-boundary averaging reliability
* [[Confidence Calibration>>FactHarbor.Product Development.Specification.Architecture.Deep Dive.Confidence Calibration.WebHome]] -- 4-layer calibration, recency penalty, low-source penalty
* [[Evidence Quality Filtering>>FactHarbor.Product Development.Specification.Architecture.Deep Dive.Evidence Quality Filtering.WebHome]] -- 7-layer evidence filtering strategy
* [[Pipeline Variants>>FactHarbor.Product Development.Specification.Architecture.Deep Dive.Pipeline Variants.WebHome]] -- CB pipeline (default) and Monolithic Dynamic pipeline
* [[Architecture>>FactHarbor.Product Development.Specification.Architecture.WebHome]] -- Architecture overview

----

**Navigation:** [[Deep Dive Index>>FactHarbor.Product Development.Specification.Architecture.Deep Dive.WebHome]] | Prev: [[Evidence Quality Filtering>>FactHarbor.Product Development.Specification.Architecture.Deep Dive.Evidence Quality Filtering.WebHome]] | Next: [[Prompt Architecture>>FactHarbor.Product Development.Specification.Architecture.Deep Dive.Prompt Architecture.WebHome]] | [[Pipeline Variants>>FactHarbor.Product Development.Specification.Architecture.Deep Dive.Pipeline Variants.WebHome]]
