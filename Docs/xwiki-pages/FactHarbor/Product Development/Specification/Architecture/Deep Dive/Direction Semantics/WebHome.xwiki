= Direction Semantics =

{{info}}
**Developer Reference** — This page documents the multi-layer direction semantics in FactHarbor's analysis pipeline. Understanding these semantics is critical for maintaining LLM-code alignment and avoiding direction confusion bugs.

**Key Files**: ##apps/web/src/lib/analyzer/types.ts##, ##apps/web/src/lib/analyzer/verdict-stage.ts##, ##apps/web/prompts/claimboundary.prompt.md##
{{/info}}

**Version**: 2.11.0 (ClaimAssessmentBoundary pipeline, 2026-02-19)
**Status**: Operational (Stage 4 advisory LLM validation — grounding + direction; no auto-correct in CB pipeline)

----

== 1. The Core Concern

**LLM interpretation must match source-code interpretation exactly**, or the system will produce inconsistent results. Direction semantics are the most common source of LLM-code misalignment.

The system has multiple "direction" concepts that can easily conflate, leading to:
- Wrong verdict flips during auto-correction
- Scope mismatch between evidence direction and sub-claim verdicts
- Counter-claims being treated incorrectly

----

== 2. The Direction Stack ==

The system has **four distinct direction layers**:

{{mermaid}}
graph TB
    subgraph Layer4["Layer 4: VERDICT DIRECTION"]
        V["verdict.truthPercentage: 0-100<br/>'Is this sub-claim TRUE or FALSE?'"]
    end

    subgraph Layer3["Layer 3: EVIDENCE DIRECTION"]
        E["claimDirection: supports | contradicts | neutral<br/>'Does this evidence SUPPORT or CONTRADICT<br/>the ORIGINAL claim?'"]
    end

    subgraph Layer2["Layer 2: CLAIM DIRECTION"]
        C["isCounterClaim: boolean<br/>'Does this sub-claim support or oppose<br/>the main thesis?'"]
    end

    subgraph Layer1["Layer 1: THESIS DIRECTION"]
        T["impliedClaim: string<br/>'What is the original user claim?'"]
    end

    Layer1 --> Layer2
    Layer2 --> Layer3
    Layer3 --> Layer4

    style Layer1 fill:#e8f5e9,color:#000
    style Layer2 fill:#fff9c4,color:#000
    style Layer3 fill:#e3f2fd,color:#000
    style Layer4 fill:#f3e5f5,color:#000
{{/mermaid}}

|= Layer |= Field |= Question Answered |= Scope
| **1. Thesis** | ##impliedClaim## | What is the original user claim? | Entire analysis
| **2. Claim** | ##isCounterClaim## | Does this sub-claim support or oppose the thesis? | Per sub-claim
| **3. Evidence** | ##claimDirection## | Does evidence support or contradict the ORIGINAL claim? | Per evidence item
| **4. Verdict** | ##truthPercentage## | Is this sub-claim TRUE or FALSE? | Per sub-claim verdict

**Critical**: Each layer has a different scope. Conflating them causes direction confusion bugs.

----

== 3. The Confusion Problem ==

=== 3.1 Example Scenario ===

**Original Claim (Thesis)**: "The trial was fair"

**Sub-claim SC1**: "The judge recused themselves due to conflict of interest"
- ##isCounterClaim: true## (opposes thesis that trial was fair)
- Evidence confirms recusal
- Evidence ##claimDirection: "supports"## (supports SC1 being true)
- **But SC1 being TRUE means the trial was NOT fair**

**Sub-claim SC2**: "The defendant received legal representation"
- ##isCounterClaim: false## (supports thesis that trial was fair)
- Evidence confirms representation
- Evidence ##claimDirection: "supports"## (supports SC2 being true)
- **SC2 being TRUE means the trial WAS fair**

=== 3.2 The Direction Matrix ===

|= Evidence Direction |= Claim Type |= Verdict Implication
| ##supports## SC1 | Counter-claim | Thesis = FALSE
| ##contradicts## SC1 | Counter-claim | Thesis = TRUE
| ##supports## SC2 | Thesis-aligned | Thesis = TRUE
| ##contradicts## SC2 | Thesis-aligned | Thesis = FALSE

**The LLM must understand this matrix. If it conflates layers, verdicts flip incorrectly.**

----

== 4. The Scope Mismatch Problem ==

{{mermaid}}
graph TD
    subgraph Evidence["EVIDENCE claimDirection"]
        Dir["claimDirection: 'contradicts'<br/>(relative to ORIGINAL CLAIM)"]
        E1["Evidence E1: 'Judge recused'<br/>→ contradicts 'trial was fair'"]
    end

    subgraph Verdict["SUB-CLAIM VERDICT"]
        SC["SC1: 'Judge recused'<br/>→ verdict should be HIGH (true)"]
        Mis["❌ MISMATCH:<br/>Evidence 'contradicts' but supports SC1"]
    end

    Evidence --> Verdict

    style Evidence fill:#e3f2fd,color:#000
    style Verdict fill:#f3e5f5,color:#000
    style Mis fill:#ffcdd2,color:#000
{{/mermaid}}

**The Problem**:
1. Evidence ##claimDirection## is relative to the ORIGINAL claim
2. Sub-claim verdict validation uses this direction
3. But sub-claims may have different direction semantics (counter-claims)
4. Validator sees "contradicts" evidence + HIGH verdict → flags as mismatch
5. **Wrong flip** if auto-correct is enabled

---

== 5. Implementation ==

=== 5.1 Evidence Direction (claimDirection) ===

**File**: ##apps/web/src/lib/analyzer/types.ts:477##

{{code language="typescript"}}
interface EvidenceItem {
  // Direction relative to ORIGINAL USER CLAIM
  claimDirection: "supports" | "contradicts" | "neutral";
}
{{/code}}

**Prompt Definition**: ##apps/web/prompts/claimboundary.prompt.md## EXTRACT_EVIDENCE section

{{code}}
For EVERY extracted evidence item, evaluate claimDirection:
- "supports_thesis": This evidence item provides evidence that SUPPORTS the user's claim being TRUE
- "contradicts_thesis": This evidence item provides evidence that CONTRADICTS the user's claim
- "contextual": This evidence item is contextual/background information

CRITICAL: claimDirection is ALWAYS relative to the ORIGINAL USER CLAIM, not sub-claims.
{{/code}}

=== 5.2 Counter-Claim Detection (isCounterClaim) ===

**File**: ##apps/web/src/lib/analyzer/types.ts:563##

{{code language="typescript"}}
interface SubClaim {
  // Does this claim test the OPPOSITE of the thesis?
  isCounterClaim: boolean;
}
{{/code}}

**Prompt Definition**: ##apps/web/prompts/claimboundary.prompt.md## CLAIM_EXTRACTION_PASS2 section

{{code}}
isCounterClaim = true when the claim evaluates the OPPOSITE position:
- Thesis: "X is fair" → Claim: "X violated due process" → isCounterClaim: true

WHY THIS MATTERS: Counter-claims have their verdicts INVERTED during aggregation.
{{/code}}

=== 5.3 Verdict Direction Validation ===

**Version**: v2.11.0 (ClaimAssessmentBoundary pipeline, Stage 4)

**File**: ##apps/web/src/lib/analyzer/verdict-stage.ts:421## (##validateVerdicts##)

The CB pipeline runs **two advisory LLM checks** as part of Stage 4 verdict generation — both are non-blocking. Verdicts are returned unchanged regardless of validation findings:

{{code language="typescript"}}
// verdict-stage.ts:421
export async function validateVerdicts(
  verdicts: CBClaimVerdict[],
  evidence: EvidenceItem[],
  llmCall: LLMCallFn,
): Promise<CBClaimVerdict[]> {
  // Check A: Grounding validation (Haiku)
  // Prompt: VERDICT_GROUNDING_VALIDATION
  // Checks: reasoning ↔ evidence alignment
  const groundingResult = await llmCall("VERDICT_GROUNDING_VALIDATION", { ... }, { tier: "haiku" });

  // Check B: Direction validation (Haiku)
  // Prompt: VERDICT_DIRECTION_VALIDATION
  // Checks: verdict % direction vs evidence direction
  const directionResult = await llmCall("VERDICT_DIRECTION_VALIDATION", { ... }, { tier: "haiku" });

  // Validation is advisory — verdicts are returned unchanged
  return verdicts;
}
{{/code}}

**Prompt Definition**: ##apps/web/prompts/claimboundary.prompt.md## VERDICT_DIRECTION_VALIDATION section

{{code}}
For each verdict:
- Read the sub-claim being rated
- Read the evidence statements (ignore direction labels — assess meaning directly)
- Determine whether the evidence supports or contradicts the sub-claim
- Compare against the verdict percentage

A verdict is MISALIGNED if:
- Evidence mostly supports the sub-claim BUT verdict is below 43%
- Evidence mostly contradicts the sub-claim BUT verdict is above 72%
- Note: Contestation or dispute about interpretation does NOT make a factual claim false

Semantic rules:
- Requirement evidence vs outcome evidence must be interpreted explicitly
- Verification mechanisms (peer review/audit/independent checks) count as corroboration
- Thesis-critical qualifiers ("without", "requires", "only if", temporal scope) must be preserved
- Interpretation dispute lowers confidence but does not invert factual direction by itself
{{/code}}

**Critical**: "ignore direction labels — assess meaning directly" — This resolves the scope mismatch by having the LLM evaluate the sub-claim directly, not via original-claim direction labels.

=== 5.4 Validation Mode — Advisory Only ===

**Direction validation in the CB pipeline is advisory. No auto-correct.**

{{code language="typescript"}}
// verdict-stage.ts — validation issues are logged but do not modify verdicts
for (const dr of directionResults) {
  if (dr.directionValid === false) {
    console.warn(`[VerdictStage] Direction issue for claim ${dr.claimId}:`, dr.issues);
  }
}
// Verdicts are returned unchanged — validation is advisory (§8.4)
return verdicts;
{{/code}}

**Design rationale**: The CB pipeline uses a 5-step LLM debate pattern (Advocate → Challenger → Reconciliation → Grounding Validation → Direction Validation). By the time direction validation runs, the verdict has already been through adversarial challenge and reconciliation. Direction validation is a final sanity check — mismatch issues are logged for monitoring, not corrected automatically.

**Note on the Orchestrated pipeline**: The removed Orchestrated pipeline had auto-correct enabled (##suggestedPct## from LLM, capped fallback formula). The CB pipeline deliberately removed auto-correct in favour of the debate pattern producing a more reliable initial verdict.

=== 5.5 Validation Failure Behavior ===

If the VERDICT_DIRECTION_VALIDATION or VERDICT_GROUNDING_VALIDATION LLM calls fail, issues are emitted as ##console.warn## and the pipeline continues:

{{code language="typescript"}}
// verdict-stage.ts — non-blocking validation
for (const gr of groundingResults) {
  if (gr.groundingValid === false) {
    console.warn(`[VerdictStage] Grounding issue for claim ${gr.claimId}:`, gr.issues);
  }
}
{{/code}}

**Operational impact**: A validation failure (LLM call error or parse failure) does not affect verdict output. The pipeline completes normally. Monitor server logs for ##[VerdictStage]## warnings.

=== 5.6 Qualifier Preservation in Claim Decomposition (2026-02-13) ===

Direction consistency depends on preserving thesis-critical qualifiers from understanding to verdict validation.

Prompt contract in ##claimboundary.prompt.md##:
- ##CLAIM_EXTRACTION_PASS2##: "QUALIFIER PRESERVATION (CRITICAL)" block requires preserving negation/modality/independence/temporal qualifiers in atomic claims.
- ##CLAIM_VALIDATION##: Gate 1 validation checks fidelity of extracted claims to original user input — prevents qualifier loss.
- ##VERDICT_DIRECTION_VALIDATION##: Semantic interpretation rules to prevent implication inversion.

**Why this matters**:
- If qualifiers are dropped (for example "without independent corroboration"), direction-validation mismatch warnings can become false positives.
- Preserving qualifiers keeps Layer 1 thesis semantics aligned with Layer 4 verdict interpretation.

----

== 6. Contestation vs Contradiction ==

**CRITICAL DISTINCTION**:

|= Concept | Meaning | Effect on Verdict
| **Contestation** | Stakeholders dispute interpretation/completeness | Reduces confidence, NOT verdict direction
| **Contradiction** | Evidence directly refutes the factual claim | Affects verdict direction

**Contestation Fields** (assertion-level, NOT source-level):

{{code language="typescript"}}
// ClaimVerdict: types.ts:315-318
interface ClaimVerdict {
  isContested: boolean;
  contestedBy: string;
  factualBasis: "established" | "disputed" | "opinion" | "unknown";
}

// EvidenceItem: types.ts:471
interface EvidenceItem {
  isContestedClaim: boolean;
  claimSource: string;
}
{{/code}}

**Prompt Definition**: ##apps/web/prompts/claimboundary.prompt.md## VERDICT_RECONCILIATION section

{{code}}
CONTESTED ≠ FALSE:
- If evidence confirms the factual component being rated BUT stakeholders dispute
  interpretation → verdict should be >=50% with reduced confidence
- If evidence directly refutes the factual component → verdict should be <50%
- Contestation affects confidence, not direction, for the factual component being rated
{{/code}}

**Example**:
- Claim: "Company released 3M pages of documents"
- Evidence: Company released 3M pages (confirmed)
- Contestation: "Only half of what was expected"
- **Correct verdict**: 70% (Mostly True - factual claim confirmed)
- **Correct confidence**: 65% (reduced due to completeness dispute)

----

== 7. LLM-Prompt Contract Requirements ==

For the LLM to interpret direction exactly as code does, the prompt must document semantics explicitly:

=== 7.1 Define Direction Relative to Original Claim ===

{{code}}
claimDirection is ALWAYS relative to the ORIGINAL USER CLAIM, not sub-claims.

Example:
- Original claim: "Trial was fair"
- Evidence: "Judge recused due to conflict"
- claimDirection: "contradicts" (contradicts "trial was fair")

Even if this evidence is cited for a sub-claim about recusal, the direction
is still relative to the ORIGINAL claim.
{{/code}}

=== 7.2 Explain Counter-Claim Semantics ===

{{code}}
Counter-claims (isCounterClaim: true) test the OPPOSITE of the thesis.

If evidence supports a counter-claim:
- The counter-claim is TRUE
- The thesis is FALSE
- verdict should be HIGH for the counter-claim
- This does NOT mean the evidence "contradicts" the counter-claim
{{/code}}

=== 7.3 Require Explicit Evidence-Claim Mapping ===

{{code}}
supportingEvidenceIds (REQUIRED): Cite at least one evidence ID when supporting
evidence exists; if none exists, use [] and explicitly state insufficiency in reasoning.
{{/code}}

=== 7.4 Multilingual Semantic Invariance ===

{{code}}
CRITICAL: Direction semantics must hold across languages, not just English keywords.

The semantic interpretation of:
- claimDirection: supports/contradicts/neutral
- isCounterClaim: true/false
- Contestation vs Contradiction

Must be invariant across all languages. The LLM must assess MEANING, not just
keyword matching. A claim that "X était injuste" (French: "X was unfair") must
be treated identically to "X was unfair" in English for direction purposes.

Prompt instructions use English keywords for consistency, but LLM interpretation
must be language-agnostic at the semantic level.
{{/code}}

----

== 8. Anti-Pattern Warning ==

{{warning}}
**DO NOT** use Layer 3 evidence direction counters alone to auto-correct Layer 4 verdicts.

**Why**: Layer 3 (##claimDirection##) is scoped to the ORIGINAL claim. Layer 4 (##truthPercentage##) is scoped to the SUB-CLAIM. These are different scopes.

**Wrong approach** (causes direction confusion bugs):
{{code language="typescript"}}
// ❌ WRONG: Auto-correct based on claimDirection counters
if (supportCount > contradictCount && verdictPct < 43) {
  verdictPct = 65; // Wrong flip!
}
{{/code}}

**Correct approach** (use LLM semantic validation):
{{code language="typescript"}}
// ✅ CORRECT: LLM evaluates sub-claim + evidence semantically (verdict-stage.ts:421)
// The CB pipeline runs VERDICT_DIRECTION_VALIDATION with:
// - Full evidence pool (id, statement, claimDirection)
// - Verdict truth percentages per claim
// - LLM assesses meaning directly, ignoring direction label scope issues
await validateVerdicts(verdicts, evidence, llmCall);
{{/code}}

**Current status**: Direction validation in the CB pipeline is **advisory** (non-blocking). The 5-step LLM debate pattern (Advocate → Challenger → Reconciliation) produces reliable initial verdicts; direction validation is a final logging check. No auto-correct. See ##verdict-stage.ts:421##.
{{/warning}}

----

== 9. Warning Metadata ==

When direction mismatches are detected, warning payloads include **legacy directional metadata** from the old counter-based approach. This metadata is kept for debugging but is **NOT reliable for sub-claim direction assessment**:

{{code language="typescript"}}
interface DirectionMismatchWarning {
  type: "verdict_direction_mismatch";
  severity: "warning";
  message: string;
  details: {
    claimId: string;
    verdictPct: number;
    legacyDirectionalMetadata: {
      supportPct: number;       // Based on claimDirection counters
      contradictPct: number;    // RELATIVE TO ORIGINAL CLAIM
      neutralPct: number;       // NOT reliable for sub-claim direction
      note: "Based on original-claim direction labels, not semantic evaluation";
    };
    llmAssessment?: string;     // LLM's semantic evaluation reason
    evidenceIds: string[];      // Which evidence was considered
  };
}
{{/code}}

**Important**: Use ##llmAssessment## for accurate direction evaluation. The ##legacyDirectionalMetadata## is kept for backward compatibility and debugging only.

----

== 10. Verification Checklist ==

To ensure LLM-code alignment:

|= Check |= Code Location |= Prompt Location
| ##claimDirection## defined relative to original claim | ##types.ts:711## (CBEvidenceItem) | ##claimboundary.prompt.md## EXTRACT_EVIDENCE
| Counter-claim direction semantics | ##types.ts:514## (isCounterClaim); inverted in ##aggregation.ts:132## | ##claimboundary.prompt.md## CLAIM_EXTRACTION_PASS2
| Qualifier preservation for decomposition | N/A (prompt contract) | ##claimboundary.prompt.md## CLAIM_EXTRACTION_PASS2 + CLAIM_VALIDATION
| Evidence-to-verdict mapping (advisory) | ##verdict-stage.ts:421## (validateVerdicts) | ##claimboundary.prompt.md## VERDICT_DIRECTION_VALIDATION
| Auto-correct: N/A — advisory validation only | ##verdict-stage.ts:468## (verdicts returned unchanged) | N/A
| Contestation ≠ False | ##types.ts:269-275## (factualBasis), ##types.ts:407## (isContestedClaim) | ##claimboundary.prompt.md## VERDICT_RECONCILIATION
| LLM per-claim direction validation | ##verdict-stage.ts:438## (VERDICT_DIRECTION_VALIDATION call) | ##claimboundary.prompt.md## VERDICT_DIRECTION_VALIDATION
| Semantic interpretation rules for direction | ##verdict-stage.ts:421## | ##claimboundary.prompt.md## VERDICT_DIRECTION_VALIDATION
| Contestation fields separate from direction | ##types.ts:407## (isContestedClaim, contestedBy) | ##claimboundary.prompt.md## VERDICT_RECONCILIATION
| Validation failure handling | ##verdict-stage.ts:456-466## (console.warn, non-blocking) | N/A (code-only)

----

== 11. Common Pitfalls ==

|= Pitfall |= Symptom |= Fix
| **Conflating layers** | Wrong verdict flips | Use LLM per-claim validation
| **Counter-based auto-correct** | Correct verdicts flipped to wrong | Use LLM ##suggestedPct## for correction magnitude, not deterministic inversion
| **Uncapped deterministic correction** | Extreme swings (5%→95%) from binary signal | Cap fallback formula to moderate range (55-75 / 25-45)
| **Contestation treated as contradiction** | High verdicts become low | Separate contestation from direction in prompts
| **Evidence direction used for sub-claim validation** | Counter-claims flagged incorrectly | Use semantic LLM validation instead
| **Ignoring degraded mode** | Silent validation failures | Monitor ##direction_validation_degraded## warnings

----

== 12. Related Documentation ==

* [[Calculations and Verdicts>>FactHarbor.Product Development.Specification.Architecture.Deep Dive.Calculations and Verdicts.WebHome]] -- Verdict scale, aggregation, counter-evidence handling
* [[Quality Gates>>FactHarbor.Product Development.Specification.Architecture.Deep Dive.Quality Gates.WebHome]] -- Gate 1 (claim validation) and Gate 4 (confidence assessment)
* [[Evidence Quality Filtering>>FactHarbor.Product Development.Specification.Architecture.Deep Dive.Evidence Quality Filtering.WebHome]] -- 7-layer evidence filtering strategy
* [[Context Detection>>FactHarbor.Product Development.Specification.Architecture.Deep Dive.Context Detection.WebHome]] -- ClaimAssessmentBoundary and EvidenceScope detection methodology
* [[Pipeline Variants>>FactHarbor.Product Development.Specification.Architecture.Deep Dive.Pipeline Variants.WebHome]] -- ClaimAssessmentBoundary vs Monolithic Dynamic pipeline overview

----

**Navigation:** [[Deep Dive Index>>FactHarbor.Product Development.Specification.Architecture.Deep Dive.WebHome]] | Prev: [[Confidence Calibration>>FactHarbor.Product Development.Specification.Architecture.Deep Dive.Confidence Calibration.WebHome]] | Next: [[Evidence Quality Filtering>>FactHarbor.Product Development.Specification.Architecture.Deep Dive.Evidence Quality Filtering.WebHome]]
