= Quality Gates Reference =

{{info}}
**Developer Reference** — Quality Gates are checkpoints in the analysis pipeline that enforce minimum standards for claim evaluation and verdict confidence.

**Key File**: ##apps/web/src/lib/analyzer/quality-gates.ts##
{{/info}}

----

== 1. Overview ==

Quality Gates ensure that:

* Only verifiable claims are analyzed (Gate 1)
* Verdicts have sufficient supporting evidence (Gate 4)
* Results meet minimum quality thresholds before publication

**Implemented Gates**: Gate 1 (Claim Validation) and Gate 4 (Verdict Confidence Assessment)

----

== 2. Gate Architecture ==

=== 2.1 Pipeline Integration ===

{{include reference="FactHarbor.Product Development.Diagrams.Quality Gates Integration.WebHome"/}}

=== 2.2 Gate States ===

|= State |= Description |= Action
| **Pass** | Meets all criteria | Proceed normally
| **Warn** | Below recommended threshold but above minimum | Proceed with warning flag
| **Fail** | Does not meet minimum criteria | Exclude from analysis or mark as insufficient

=== 2.3 Result Metadata ===

Every analysis result includes gate statistics:

{{code language="typescript"}}
interface QualityGates {
  gate1Stats: {
    totalClaims: number;
    validClaims: number;
    excludedClaims: number;
    exclusionReasons: { claimId: string; reason: string }[];
  };
  gate4Stats: {
    totalVerdicts: number;
    highConfidence: number;
    mediumConfidence: number;
    lowConfidence: number;
    insufficient: number;
  };
}
{{/code}}

----

== 3. Gate 1: Claim Validation ==

=== 3.1 Purpose ===

Filter out non-verifiable claims before research begins, preventing wasted resources on opinions, predictions, or vague statements.

=== 3.2 Criteria ===

**Claims are EXCLUDED if**:
1. **Opinion/Editorial**: Subjective judgment without factual basis
1*. Example: "Policy X is the best approach"
1*. Action: Exclude unless claim is central to thesis

1. **Prediction/Speculation**: Future-oriented claims that cannot be verified
1*. Example: "Technology Y will dominate the market by 2030"
1*. Action: Exclude unless claim is central to thesis

1. **Low Specificity**: Vague statements without concrete assertions
1*. Example: "Some experts believe..."
1*. Action: Exclude unless claim is central to thesis

**Claims are KEPT if**:
* **Factual assertion**: Verifiable statement about past/present
* **Central claim**: Core thesis claim (kept regardless of specificity)
* **Attribution claim**: Claims about what someone said/did

=== 3.3 Implementation ===

**File**: ##apps/web/src/lib/analyzer/orchestrated.ts##
**Function**: Applied during ##understandClaim()## phase
**Phase**: UNDERSTAND (Phase 1)

**Exclusion Process**:
1. LLM extracts claims and marks each with role and type
1. Deterministic filter applies Gate 1 criteria
1. Excluded claims logged with reasons
1. Valid claims proceed to research phase

=== 3.4 Configuration ===

**UCM Pipeline Config**:
{{code language="json"}}
{
  "gate1Enabled": true,
  "gate1KeepCentralClaims": true
}
{{/code}}

=== 3.5 Examples ===

**Example 1: Opinion Excluded**
{{code}}
Claim: "The Supreme Court's decision was unjust."
Role: evaluative
Result: EXCLUDED (opinion - no factual basis)
Reason: "Evaluative opinion without factual assertion"
{{/code}}

**Example 2: Central Claim Kept**
{{code}}
Claim: "The policy will significantly improve outcomes."
Role: core
Result: KEPT (central to thesis, despite low specificity)
Reason: "Central claim kept for analysis"
{{/code}}

**Example 3: Factual Assertion Kept**
{{code}}
Claim: "The court ruled in favor of Party A on January 15, 2025."
Role: core
Type: factual
Result: KEPT (verifiable factual assertion)
{{/code}}

----

== 4. Gate 4: Verdict Confidence Assessment ==

=== 4.1 Purpose ===

Ensure verdicts have sufficient supporting evidence before publication, preventing low-confidence judgments from misleading users.

=== 4.2 Confidence Tiers ===

|= Tier |= Criteria |= Interpretation
| **HIGH** | 3+ sources AND 5+ facts AND reasoning >100 chars | Strong evidence base, high reliability
| **MEDIUM** | 2+ sources AND 3+ facts AND reasoning >50 chars | Adequate evidence, moderate reliability
| **LOW** | 1+ sources AND 1+ facts | Minimal evidence, low reliability
| **INSUFFICIENT** | <1 source OR <1 fact | Insufficient evidence for verdict

=== 4.3 Implementation ===

**File**: ##apps/web/src/lib/analyzer/orchestrated.ts##
**Function**: ##validateVerdictGate4()##
**Phase**: VERDICT GENERATION (Phase 3)

**Validation Process**:
1. Count sources supporting verdict
1. Count facts extracted from sources
1. Measure reasoning length
1. Assign confidence tier
1. Apply context scoping for counter-evidence
1. Flag verdicts below threshold

=== 4.4 Context Scoping ===

Counter-evidence is scoped to relevant analysis contexts:

{{code language="typescript"}}
// Only count criticism facts that are:
// 1. In the same context as the verdict, OR
// 2. Not scoped to any specific context (general criticism)
const contradictingFactCount = facts.filter(f =>
  !verdict.supportingEvidenceIds.includes(f.id) &&
  f.category === "criticism" &&
  (!f.contextId || f.contextId === verdict.contextId)
).length;
{{/code}}

This prevents criticism of one analysis context from penalizing claims about a different analysis context.

=== 4.5 Central Claim Exception ===

**Central claims remain publishable even if confidence is low**, because they are core to the thesis and users need to see the verdict regardless of evidence sufficiency.

=== 4.6 Configuration ===

**UCM Pipeline Config**:
{{code language="json"}}
{
  "gate4Enabled": true,
  "gate4MinSources": 2,
  "gate4MinFacts": 3,
  "gate4MinReasoningLength": 50
}
{{/code}}

=== 4.7 Examples ===

**Example 1: HIGH Confidence**
{{code}}
Verdict: "MOSTLY-TRUE" (85%)
Sources: 4 (Reuters, AP, BBC, Government site)
Facts: 12
Reasoning: 150 chars
Result: HIGH confidence tier
Action: Publish with full confidence
{{/code}}

**Example 2: LOW Confidence (Central Claim)**
{{code}}
Verdict: "UNVERIFIED" (50%)
Sources: 1 (Blog post)
Facts: 2
Reasoning: 80 chars
Claim: Central
Result: LOW confidence tier
Action: Publish with warning (central claim exception)
{{/code}}

**Example 3: INSUFFICIENT (Non-Central)**
{{code}}
Verdict: "UNVERIFIED" (50%)
Sources: 0
Facts: 0
Reasoning: 30 chars
Claim: Non-central
Result: INSUFFICIENT
Action: Exclude from report or mark as "No evidence found"
{{/code}}

----

== 5. Confidence Impact on Verdict Calculation ==

=== 5.1 Truth Percentage Modulation ===

Confidence modulates the final truth percentage within each verdict band:

{{code language="typescript"}}
function truthFromBand(band: "strong" | "partial" | "uncertain" | "refuted", confidence: number): number {
  const conf = normalizePercentage(confidence) / 100;
  switch (band) {
    case "strong":    return Math.round(72 + 28 * conf);  // 72-100%
    case "partial":   return Math.round(50 + 35 * conf);  // 50-85%
    case "uncertain": return Math.round(35 + 30 * conf);  // 35-65%
    case "refuted":   return Math.round(28 * (1 - conf)); // 0-28%
  }
}
{{/code}}

=== 5.2 Example Impact ===

**"strong" band with varying confidence**:
* **High confidence** (90%): 72 + 28x0.9 = 97% -> **TRUE**
* **Medium confidence** (60%): 72 + 28x0.6 = 89% -> **TRUE**
* **Low confidence** (30%): 72 + 28x0.3 = 80% -> **MOSTLY-TRUE**

Same evidence band, but lower confidence pulls verdict down within the band.

=== 5.3 MIXED vs UNVERIFIED Distinction ===

Confidence determines whether 43-57% range is **MIXED** or **UNVERIFIED**:

{{code language="typescript"}}
const MIXED_CONFIDENCE_THRESHOLD = 60;

if (truthPercentage >= 43 && truthPercentage <= 57) {
  return confidence >= 60 ? "MIXED" : "UNVERIFIED";
}
{{/code}}

* **MIXED** (confidence >= 60%): Evidence on both sides, high confidence in mixed state
* **UNVERIFIED** (confidence < 60%): Insufficient evidence, low confidence

----

== 6. Confidence Penalties ==

After Gate 4 assessment, two additional confidence penalty mechanisms may reduce overall confidence:

=== 6.1 Recency Evidence Gap Penalty ===

**Purpose**: Reduce confidence when time-sensitive claims lack recent evidence.

**Trigger**: Topic is recency-sensitive AND no evidence found within ##recencyWindowMonths## (default: 6 months).

**Graduated Mode (v2.11, default: enabled)**:

{{code}}
effectivePenalty = round(maxPenalty x staleness x volatility x volume)
{{/code}}

**Factor 1: Staleness Curve** — How far outside the recency window is the evidence?

* Evidence within window: multiplier = 0 (no penalty)
* Evidence outside window: linear ramp from 0 to 1 over one additional window period
* At 2x window: capped at 1.0
* No dates found: 1.0 (full staleness)

**Factor 2: Topic Volatility** — How time-critical is the topic?

|= Granularity |= Multiplier |= Example
| ##week## | 1.0 | Breaking news
| ##month## | 0.8 | Monthly-cycle topics
| ##year## | 0.4 | Institutional / annual
| ##none## | 0.2 | Enduring / structural
| //undefined// | 0.7 | Fallback when LLM didn't assess

**Factor 3: Evidence Volume** — More evidence attenuates the penalty.

|= dateCandidates |= Multiplier
| 0 | 1.0
| 1-10 | 0.9
| 11-25 | 0.7
| 26+ | 0.5

**Example — Institutional topic**:
* Evidence 14 months old, window = 6 months -> staleness = 1.0 (capped)
* Granularity = "year" -> volatility = 0.4
* 35 date candidates -> volume = 0.5
* **Effective penalty = round(20 x 1.0 x 0.4 x 0.5) = 4 points** (vs. 20 flat)

=== 6.2 Low-Source Confidence Penalty ===

**Purpose**: Reduce confidence when evidence base is thin.

**Trigger**: Unique source count <= ##lowSourceThreshold## (default: 2).

**Penalty**: Flat ##lowSourceConfidencePenalty## (default: 15 points).

=== 6.3 Confidence Floor ===

After all penalties, confidence cannot drop below ##minConfidenceFloor## (default: 10%).

----

== 7. Configuration Reference ==

{{code language="json"}}
{
  "gate1Enabled": true,
  "gate1KeepCentralClaims": true,
  "gate4Enabled": true,
  "gate4MinSources": 2,
  "gate4MinFacts": 3,
  "gate4MinReasoningLength": 50,
  "mixedConfidenceThreshold": 60,
  "recencyWindowMonths": 6,
  "recencyConfidencePenalty": 20,
  "recencyGraduatedPenalty": true,
  "lowSourceThreshold": 2,
  "lowSourceConfidencePenalty": 15,
  "minConfidenceFloor": 10
}
{{/code}}

|= Setting |= Default |= Rationale
| ##gate1Enabled## | ##true## | Quality control essential
| ##gate1KeepCentralClaims## | ##true## | Users need to see core thesis verdicts
| ##gate4Enabled## | ##true## | Prevent low-quality verdicts
| ##gate4MinSources## | ##2## | Balance between quality and coverage
| ##gate4MinFacts## | ##3## | Minimum for reasonable confidence
| ##gate4MinReasoningLength## | ##50## | Ensure non-trivial reasoning
| ##mixedConfidenceThreshold## | ##60## | Clear distinction between mixed/unverified
| ##recencyWindowMonths## | ##6## | Time-sensitive evidence window
| ##recencyConfidencePenalty## | ##20## | Max penalty for recency gap
| ##recencyGraduatedPenalty## | ##true## | Use graduated (multi-factor) penalty
| ##lowSourceThreshold## | ##2## | Source count for thin-evidence penalty
| ##lowSourceConfidencePenalty## | ##15## | Penalty for thin evidence base
| ##minConfidenceFloor## | ##10## | Minimum confidence after all penalties

----

== 8. Proposed Gates (Not Yet Implemented) ==

=== 8.1 Gate 2: Source Quality (Proposed) ===

**Purpose**: Filter low-quality sources before evidence extraction.
**Status**: Proposed but not implemented (Source Reliability system exists but not integrated as gate).

=== 8.2 Gate 3: Evidence Relevance (Proposed) ===

**Purpose**: Filter tangential or low-probative-value evidence.
**Status**: Proposed but not implemented (Evidence filtering exists but not formalized as gate).

----

== 9. Debugging and Diagnostics ==

=== 9.1 Common Issues ===

|= Issue |= Cause |= Solution
| Too many claims excluded by Gate 1 | Input is primarily opinion/editorial | Gate 1 is working correctly; input may not be fact-checkable
| All verdicts marked LOW confidence | Search returning few sources | Check search provider credentials, adjust Gate 4 thresholds
| Central claims excluded by Gate 1 | ##gate1KeepCentralClaims=false## | Enable central claim exception in UCM Pipeline config

=== 9.2 Testing ===

**Unit Tests**: ##apps/web/src/lib/analyzer/__tests__/quality-gates.test.ts##

**Coverage**: Gate 1 exclusion scenarios, central claim exception, Gate 4 confidence tier assignment, context scoping, central claim exception.

----

== 10. Related Documentation ==

* [[Calculations and Verdicts>>FactHarbor.Product Development.Specification.Architecture.Deep Dive.Calculations and Verdicts.WebHome]] — Verdict calculation methodology, confidence modulation
* [[Pipeline Variants>>FactHarbor.Product Development.Specification.Architecture.Deep Dive.Pipeline Variants.WebHome]] — Pipeline variants and quality gate enforcement
* [[Evidence Quality Filtering>>FactHarbor.Product Development.Specification.Architecture.Deep Dive.Evidence Quality Filtering.WebHome]] — Evidence filtering (related to proposed Gate 3)
* [[Architecture>>FactHarbor.Product Development.Specification.Architecture.WebHome]] — Architecture overview

----

**Navigation:** [[Deep Dive Index>>FactHarbor.Product Development.Specification.Architecture.Deep Dive.WebHome]] | Prev: [[Pipeline Variants>>FactHarbor.Product Development.Specification.Architecture.Deep Dive.Pipeline Variants.WebHome]] | Next: [[Context Detection>>FactHarbor.Product Development.Specification.Architecture.Deep Dive.Context Detection.WebHome]]
