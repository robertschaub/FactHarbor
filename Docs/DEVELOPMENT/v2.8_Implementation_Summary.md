# v2.8 Implementation Summary - Quick Reference

**Date:** 2026-01-19  
**Full Plan:** `Docs/DEVELOPMENT/v2.8_EvidenceScope_Implementation_Plan.md`

---

## Executive Summary

**Goal:** Improve UI transparency by displaying EvidenceScope metadata and clarifying ArticleFrame usage.

**Features:**
1. ✅ EvidenceScope Tooltips - Show source methodology on hover
2. ✅ Methodology Sub-Grouping - Auto-group facts by methodology (3+ methodologies)
3. ✅ ArticleFrame Banner - Display article context when populated
4. ✅ Enhanced LLM Prompts - Clear guidance on ArticleFrame usage

**Effort:** 5-7 days for senior developer  
**Breaking Changes:** None  
**Target Version:** v2.8.0

---

## ⚠️ CRITICAL: Multi-Pipeline Implementation

This implementation must work across **THREE different pipeline variants**:

### Data Structure Differences

```typescript
// ORCHESTRATED & CANONICAL
{
  understanding: {
    analysisContext: string,      // ArticleFrame (singular)
    analysisContexts: [...],       // AnalysisContexts (plural)
  },
  facts: ExtractedFact[] {         // Structured facts
    evidenceScope: {               // Methodology metadata
      methodology: string,
      boundaries: string,
      geographic: string,
      temporal: string
    }
  }
}

// DYNAMIC
{
  rawJson: {
    articleFrame: string,          // Optional, LLM-populated
    summary: string,
    verdict: {...},
    findings: [...]
  },
  citations: Citation[] {          // Simple citations
    url: string,
    title: string,
    excerpt: string,
    accessedAt: string
  }
}
```

### Feature Matrix

| Feature | Orchestrated | Canonical | Dynamic |
|---------|-------------|-----------|---------|
| EvidenceScope Tooltips | ✅ Full | ✅ Full | ⚠️ Simplified |
| Methodology Grouping | ✅ Full | ✅ Full | ❌ N/A |
| ArticleFrame Banner | ✅ Full | ✅ Full | ✅ Full |

---

## New Files to Create

```
apps/web/src/app/jobs/[id]/
  components/
    EvidenceScopeTooltip.tsx          (NEW)
    EvidenceScopeTooltip.module.css   (NEW)
    MethodologySubGroup.tsx            (NEW)
    MethodologySubGroup.module.css     (NEW)
    ArticleFrameBanner.tsx             (NEW)
    ArticleFrameBanner.module.css      (NEW)
  utils/
    methodologyGrouping.ts             (NEW)
    methodologyGrouping.test.ts        (NEW)
  components/
    EvidenceScopeTooltip.test.tsx      (NEW)
```

---

## Files to Modify

```
apps/web/src/app/jobs/[id]/
  page.tsx                                    (UPDATE - 3 locations)
  components/ClaimsGroupedByScope.tsx         (UPDATE)

apps/web/src/lib/analyzer/prompts/base/
  understand-base.ts                          (UPDATE)
  dynamic-plan-base.ts                        (UPDATE)

Docs/
  DEVELOPMENT/LLM_Prompt_Improvements.md      (UPDATE)
  CHANGELOG.md                                (ADD v2.8 entry)
```

---

## Key Code Snippets

### 1. Multi-Pipeline ArticleFrame Display

```typescript
// In page.tsx - after ArticleSummaryBox
{(() => {
  let articleFrame = null;
  
  // Orchestrated & Canonical
  if (result?.understanding?.analysisContext) {
    articleFrame = result.understanding.analysisContext;
  }
  
  // Dynamic
  if (!articleFrame && result?.rawJson?.articleFrame) {
    articleFrame = result.rawJson.articleFrame;
  }
  
  if (articleFrame) {
    return <ArticleFrameBanner articleFrame={articleFrame} />;
  }
  
  return null;
})()}
```

### 2. Safe Methodology Grouping

```typescript
// In ClaimsGroupedByScope.tsx
{(() => {
  // Safety check: only group if facts exist
  if (!context.facts || context.facts.length === 0) {
    return <div>No facts available</div>;
  }

  const methodologyGroups = groupFactsByMethodology(context.facts);
  
  if (methodologyGroups) {
    // Show grouped view
    return methodologyGroups.map((group) => (
      <MethodologySubGroup key={group.key} group={group} renderFact={...} />
    ));
  } else {
    // Show flat list
    return context.facts.map((fact) => <FactCard key={fact.id} fact={fact} />);
  }
})()}
```

### 3. EvidenceScope Tooltip Integration

```typescript
// In fact display
<div className={styles.factText}>
  {fact.fact}
  {fact.evidenceScope && (
    <EvidenceScopeTooltip evidenceScope={fact.evidenceScope} />
  )}
</div>
```

---

## Testing Strategy

### Unit Tests
- `methodologyGrouping.test.ts` - Grouping logic
- `EvidenceScopeTooltip.test.tsx` - Tooltip rendering

### Integration Tests
- Test with all 3 pipeline variants
- Test with 0, 1, 2, 3+ methodologies
- Test ArticleFrame display/hide logic

### E2E Tests
1. **Hydrogen case** (Orchestrated & Canonical) - Multi-methodology
2. **Bolsonaro case** (All pipelines) - Multi-context
3. **Simple claim** (All pipelines) - No frame
4. **Dynamic pipeline** (Dynamic only) - Free-form output

---

## Acceptance Criteria (TL;DR)

### Must Have
- [ ] EvidenceScope tooltips work on orchestrated & canonical
- [ ] Methodology grouping appears when 3+ methodologies (orchestrated & canonical)
- [ ] ArticleFrame banner works on ALL pipelines
- [ ] Dynamic pipeline doesn't crash when attempting methodology grouping
- [ ] All 3 pipeline variants tested

### Nice to Have
- [ ] Keyboard accessibility (Tab + Enter)
- [ ] Mobile responsive
- [ ] Dark mode support

### Must NOT
- [ ] Break existing functionality
- [ ] Crash on missing data
- [ ] Show tooltips when no EvidenceScope present
- [ ] Attempt methodology grouping on dynamic pipeline

---

## Common Pitfalls to Avoid

### ❌ DON'T DO THIS

```typescript
// Assuming ExtractedFacts exist
const groups = groupFactsByMethodology(context.facts);
groups.map(...) // CRASH if facts is undefined!
```

```typescript
// Hardcoding for one pipeline
const articleFrame = result.understanding.analysisContext;
// FAILS on dynamic pipeline!
```

```typescript
// Not checking for empty EvidenceScope
{fact.evidenceScope && (
  <EvidenceScopeTooltip evidenceScope={fact.evidenceScope} />
)}
// Component should also check if ALL fields are empty
```

### ✅ DO THIS INSTEAD

```typescript
// Always check existence
if (!context.facts || context.facts.length === 0) {
  return <div>No facts</div>;
}
const groups = groupFactsByMethodology(context.facts);
```

```typescript
// Multi-source fallback
let articleFrame = null;
if (result?.understanding?.analysisContext) {
  articleFrame = result.understanding.analysisContext;
}
if (!articleFrame && result?.rawJson?.articleFrame) {
  articleFrame = result.rawJson.articleFrame;
}
```

```typescript
// Component checks for meaningful data
const hasData = evidenceScope.methodology || 
                evidenceScope.boundaries || 
                evidenceScope.geographic || 
                evidenceScope.temporal;
if (!hasData) return null;
```

---

## Timeline & Milestones

### Day 1-2: Core Components
- [ ] Create EvidenceScopeTooltip
- [ ] Create MethodologySubGroup
- [ ] Write unit tests

### Day 3-4: Integration
- [ ] Integrate tooltips into fact display
- [ ] Integrate methodology grouping
- [ ] Multi-pipeline ArticleFrame logic

### Day 5: Prompts
- [ ] Update understand-base.ts
- [ ] Update dynamic-plan-base.ts
- [ ] Add ArticleFrame examples

### Day 6: Testing
- [ ] Test all 3 pipelines
- [ ] E2E testing (4 test cases)
- [ ] Mobile & accessibility testing

### Day 7: Polish & Documentation
- [ ] Update CHANGELOG
- [ ] Update LLM_Prompt_Improvements.md
- [ ] Code review preparation
- [ ] Create PR

---

## Success Metrics

### Functional
- [ ] 100% of facts with EvidenceScope show tooltips
- [ ] Methodology grouping appears when 3+ methodologies
- [ ] ArticleFrame banner appears when populated (all pipelines)
- [ ] No crashes on dynamic pipeline

### Quality
- [ ] All tests pass
- [ ] Test coverage ≥80%
- [ ] No TypeScript errors
- [ ] No linter warnings

### User Experience
- [ ] Tooltips accessible via keyboard
- [ ] Mobile responsive
- [ ] Dark mode support
- [ ] Load time impact <50ms

---

## Questions? Issues?

**Read the full plan:**  
`Docs/DEVELOPMENT/v2.8_EvidenceScope_Implementation_Plan.md`

**Reference documents:**
- `Docs/ARCHITECTURE/UI_Grouping_and_ArticleFrame_Analysis_2026-01-19.md`
- `Docs/REFERENCE/TERMINOLOGY.md`

**Pipeline-specific data structures:**
- Orchestrated: `apps/web/src/lib/analyzer.ts` (line ~6700)
- Canonical: `apps/web/src/lib/analyzer/monolithic-canonical.ts` (line ~625)
- Dynamic: `apps/web/src/lib/analyzer/monolithic-dynamic.ts` (line ~400)

---

**END OF SUMMARY**

*Ready to implement? Start with Day 1-2 tasks.*
