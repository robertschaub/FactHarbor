# Implementation Plan: UI Grouping & ArticleFrame Enhancements
## FactHarbor v2.8 Feature Implementation

**Date:** 2026-01-19  
**Target Version:** v2.8.0  
**Estimated Effort:** M-L (5-7 days for senior developer)  
**Breaking Changes:** None (v2.8), Yes (v3.0 future)  
**Dependencies:** None  

**Reference Documents:**
- Analysis: `Docs/ARCHITECTURE/UI_Grouping_and_ArticleFrame_Analysis_2026-01-19.md`
- Terminology: `Docs/REFERENCE/TERMINOLOGY.md`

---

## ‚ö†Ô∏è CRITICAL: Pipeline Compatibility

FactHarbor supports **THREE pipeline variants**, each with different data structures:

### Pipeline Data Structures

| Pipeline | Data Structure | Fields |
|----------|---------------|--------|
| **Orchestrated** | Structured canonical | `understanding.analysisContext`, `ExtractedFact[]` with `evidenceScope` |
| **Monolithic Canonical** | Structured canonical | Same as orchestrated |
| **Monolithic Dynamic** | Free-form JSON | `rawJson.articleFrame` (optional), `citations[]` array |

### Feature Compatibility Matrix

| Feature | Implementation Approach |
|---------|------------------------|
| **EvidenceScope Tooltips** | Orchestrated & Canonical: Full support via `ExtractedFact.evidenceScope`<br>Dynamic: Simplified citation metadata only |
| **Methodology Sub-Grouping** | Orchestrated & Canonical: Full support<br>Dynamic: **NOT APPLICABLE** (no structured facts) |
| **ArticleFrame Banner** | ALL pipelines: Multi-source fallback logic |
| **LLM Prompts** | ALL pipelines: Update all relevant prompt files |

### Key Implementation Rules

1. **Always check data structure** before accessing fields
2. **Use fallback logic** for ArticleFrame (try multiple sources)
3. **Skip methodology grouping** for dynamic pipeline (no ExtractedFacts)
4. **Test with all three pipelines** before considering feature complete

---

## Executive Summary

**Goal:** Improve UI transparency by displaying EvidenceScope metadata and clarifying ArticleFrame usage.

**Two-Phase Approach:**
- **Phase 1 (v2.8):** Add EvidenceScope tooltips + enhance ArticleFrame guidance (no breaking changes)
- **Phase 2 (v3.0):** Rename `analysisContext` ‚Üí `articleFrame` (breaking change, future work)

**This Plan:** Covers Phase 1 (v2.8) implementation only.

---

## Overview: What We're Building

### Pipeline Support Matrix

| Feature | Orchestrated | Monolithic Canonical | Monolithic Dynamic |
|---------|--------------|---------------------|-------------------|
| EvidenceScope Tooltips | ‚úÖ Full | ‚úÖ Full | ‚ö†Ô∏è Partial (via citations) |
| Methodology Sub-Grouping | ‚úÖ Full | ‚úÖ Full | ‚ùå N/A (no ExtractedFacts) |
| ArticleFrame Banner | ‚úÖ Full | ‚úÖ Full | ‚úÖ Full |
| ArticleFrame Prompts | ‚úÖ Full | ‚úÖ Full | ‚úÖ Full |

**Key Differences:**
- **Orchestrated & Monolithic Canonical:** Use `ExtractedFact[]` with `evidenceScope` field
- **Monolithic Dynamic:** Uses free-form JSON with `citations[]` array (no structured facts)

### Feature 1: EvidenceScope Tooltips
**Current State:** EvidenceScope exists in data but is invisible to users  
**Target State:** Hoverable tooltips on facts showing source methodology

**Before:**
```
‚úì Fact F1: "TSE applied electoral law correctly"
```

**After (Orchestrated & Canonical):**
```
‚úì Fact F1: "TSE applied electoral law correctly" ‚ÑπÔ∏è
   [Hover reveals: Methodology: Legal analysis | Geographic: Brazil | Temporal: 2023]
```

**After (Dynamic):**
```
üìé Citation: "TSE Electoral Court Decision 2023" ‚ÑπÔ∏è
   [Hover reveals: URL | Accessed: 2026-01-19 14:23 UTC]
```

### Feature 2: Methodology Sub-Grouping (Adaptive)
**Current State:** All facts listed flat within each AnalysisContext  
**Target State:** Automatic sub-grouping when 3+ distinct methodologies detected

**Before:**
```
Context: Well-to-Wheel Analysis
  - F1: Study A shows 40%
  - F2: Study A includes emissions
  - F3: Study B shows 38%
  - F4: Study B uses EU data
```

**After:**
```
Context: Well-to-Wheel Analysis
  üìä GREET Model (US DOE)
    - F1: Study A shows 40%
    - F2: Study A includes emissions
  üìä JRC-EU Well-to-Wheel
    - F3: Study B shows 38%
    - F4: Study B uses EU data
```

### Feature 3: ArticleFrame Guidance
**Current State:** LLM prompts lack clear guidance on when/how to populate ArticleFrame  
**Target State:** Enhanced prompts with examples and usage rules

### Feature 4: ArticleFrame UI Display
**Current State:** ArticleFrame field exists but never shown in UI  
**Target State:** Optional page-level context banner when field is populated

---

## Phase 1: v2.8 Implementation

### Pre-Implementation Checklist

- [ ] Review analysis document (`UI_Grouping_and_ArticleFrame_Analysis_2026-01-19.md`)
- [ ] Verify current TypeScript definitions in `apps/web/src/lib/analyzer/types.ts`
- [ ] Check current UI component structure in `apps/web/src/app/jobs/[id]/page.tsx`
- [ ] Review LLM prompts in `apps/web/src/lib/analyzer/prompts/base/`
- [ ] Create feature branch: `feature/v2.8-evidence-scope-display`

---

## Task Breakdown

### Task 1: Add EvidenceScope Tooltip Component

**Priority:** High  
**Effort:** S (4 hours)  
**Files to Modify:**
- `apps/web/src/app/jobs/[id]/components/EvidenceScopeTooltip.tsx` (NEW)
- `apps/web/src/app/jobs/[id]/page.module.css` (UPDATE)

#### Subtask 1.1: Create Tooltip Component

**File:** `apps/web/src/app/jobs/[id]/components/EvidenceScopeTooltip.tsx`

```typescript
import React, { useState } from 'react';
import styles from './EvidenceScopeTooltip.module.css';
import type { EvidenceScope } from '@/lib/analyzer/types';

interface EvidenceScopeTooltipProps {
  evidenceScope: EvidenceScope;
  className?: string;
}

export function EvidenceScopeTooltip({ evidenceScope, className = '' }: EvidenceScopeTooltipProps) {
  const [isVisible, setIsVisible] = useState(false);

  // If no meaningful scope data, don't show tooltip
  const hasData = evidenceScope.methodology || 
                  evidenceScope.boundaries || 
                  evidenceScope.geographic || 
                  evidenceScope.temporal;
  
  if (!hasData) return null;

  return (
    <span 
      className={`${styles.tooltipWrapper} ${className}`}
      onMouseEnter={() => setIsVisible(true)}
      onMouseLeave={() => setIsVisible(false)}
      onFocus={() => setIsVisible(true)}
      onBlur={() => setIsVisible(false)}
      tabIndex={0}
      role="button"
      aria-label="Show evidence scope details"
    >
      <span className={styles.icon} aria-hidden="true">‚ÑπÔ∏è</span>
      {isVisible && (
        <div className={styles.tooltip} role="tooltip">
          <div className={styles.tooltipHeader}>üìä Evidence Scope</div>
          <div className={styles.tooltipContent}>
            {evidenceScope.name && (
              <div className={styles.tooltipRow}>
                <strong>Name:</strong> {evidenceScope.name}
              </div>
            )}
            {evidenceScope.methodology && (
              <div className={styles.tooltipRow}>
                <strong>Methodology:</strong> {evidenceScope.methodology}
              </div>
            )}
            {evidenceScope.boundaries && (
              <div className={styles.tooltipRow}>
                <strong>Boundaries:</strong> {evidenceScope.boundaries}
              </div>
            )}
            {evidenceScope.geographic && (
              <div className={styles.tooltipRow}>
                <strong>Geographic:</strong> {evidenceScope.geographic}
              </div>
            )}
            {evidenceScope.temporal && (
              <div className={styles.tooltipRow}>
                <strong>Temporal:</strong> {evidenceScope.temporal}
              </div>
            )}
          </div>
        </div>
      )}
    </span>
  );
}
```

#### Subtask 1.2: Add Tooltip Styles

**File:** `apps/web/src/app/jobs/[id]/components/EvidenceScopeTooltip.module.css`

```css
.tooltipWrapper {
  position: relative;
  display: inline-block;
  margin-left: 4px;
  cursor: help;
}

.icon {
  font-size: 14px;
  opacity: 0.6;
  transition: opacity 0.2s;
}

.tooltipWrapper:hover .icon,
.tooltipWrapper:focus .icon {
  opacity: 1;
}

.tooltip {
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%);
  margin-bottom: 8px;
  min-width: 280px;
  max-width: 400px;
  background: #2c3e50;
  color: #ecf0f1;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  z-index: 1000;
  padding: 0;
  animation: fadeIn 0.2s ease-in;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateX(-50%) translateY(4px);
  }
  to {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }
}

.tooltipHeader {
  background: #34495e;
  padding: 8px 12px;
  border-radius: 8px 8px 0 0;
  font-weight: 600;
  font-size: 13px;
  border-bottom: 1px solid #4a5f7f;
}

.tooltipContent {
  padding: 8px 12px;
  font-size: 12px;
  line-height: 1.5;
}

.tooltipRow {
  margin: 4px 0;
}

.tooltipRow strong {
  color: #3498db;
  margin-right: 4px;
}

/* Arrow pointing down */
.tooltip::after {
  content: '';
  position: absolute;
  top: 100%;
  left: 50%;
  transform: translateX(-50%);
  width: 0;
  height: 0;
  border-left: 8px solid transparent;
  border-right: 8px solid transparent;
  border-top: 8px solid #2c3e50;
}

/* Mobile adjustments */
@media (max-width: 768px) {
  .tooltip {
    min-width: 240px;
    font-size: 11px;
  }
}
```

#### Subtask 1.3: Integrate Tooltip into Fact Display

**File:** `apps/web/src/app/jobs/[id]/page.tsx`

**Location:** Find the `ClaimCard` component or fact display section

**Changes:**

1. Import the new component:
```typescript
import { EvidenceScopeTooltip } from './components/EvidenceScopeTooltip';
```

2. Update fact display for **orchestrated & canonical pipelines** (search for where facts are rendered):
```typescript
// BEFORE:
<div className={styles.factText}>
  {fact.fact}
</div>

// AFTER:
<div className={styles.factText}>
  {fact.fact}
  {fact.evidenceScope && (
    <EvidenceScopeTooltip evidenceScope={fact.evidenceScope} />
  )}
</div>
```

3. Update citation display for **dynamic pipeline** (in `DynamicResultViewer`):
```typescript
// Find where citations are rendered in DynamicResultViewer
// BEFORE:
<div className={styles.citationText}>
  {citation.title}
</div>

// AFTER:
<div className={styles.citationText}>
  {citation.title}
  <span className={styles.citationMeta} title={`Accessed: ${citation.accessedAt}`}>
    ‚ÑπÔ∏è
  </span>
</div>
```

**Acceptance Criteria:**
- [ ] Tooltip appears on hover/focus over info icon **(orchestrated & canonical only)**
- [ ] Tooltip shows all populated EvidenceScope fields
- [ ] Tooltip does not appear if EvidenceScope is empty
- [ ] Tooltip is keyboard accessible (Tab + Enter)
- [ ] Tooltip displays correctly on mobile (no overflow)
- [ ] Icon has appropriate opacity states (0.6 default, 1.0 on hover)
- [ ] **Dynamic pipeline:** Citations show accessed timestamp in simpler format

---

### Task 2: Add Methodology Sub-Grouping (Adaptive)

**Priority:** Medium  
**Effort:** M (8 hours)  
**Files to Modify:**
- `apps/web/src/app/jobs/[id]/components/MethodologySubGroup.tsx` (NEW)
- `apps/web/src/app/jobs/[id]/components/ClaimsGroupedByScope.tsx` (UPDATE)
- `apps/web/src/app/jobs/[id]/page.tsx` (UPDATE)

**‚ö†Ô∏è IMPORTANT: Pipeline Compatibility**

This feature **ONLY applies to orchestrated and monolithic_canonical pipelines**, which use `ExtractedFact[]` with structured `evidenceScope` fields.

The **monolithic_dynamic pipeline** uses free-form JSON without structured facts, so this feature will:
- ‚úÖ Be implemented for orchestrated & canonical
- ‚ùå Be skipped for dynamic (no ExtractedFacts to group)

**Implementation Note:** Add a conditional check in the UI to only attempt methodology grouping when facts are available.

#### Subtask 2.1: Create Utility to Detect Methodologies

**File:** `apps/web/src/app/jobs/[id]/utils/methodologyGrouping.ts` (NEW)

```typescript
import type { ExtractedFact, EvidenceScope } from '@/lib/analyzer/types';

export interface MethodologyGroup {
  key: string;
  name: string;
  icon: string;
  facts: ExtractedFact[];
}

/**
 * Groups facts by their EvidenceScope methodology.
 * Returns null if fewer than 3 distinct methodologies (no grouping needed).
 */
export function groupFactsByMethodology(facts: ExtractedFact[]): MethodologyGroup[] | null {
  // Extract unique methodologies
  const methodologyMap = new Map<string, ExtractedFact[]>();
  const noMethodologyFacts: ExtractedFact[] = [];

  for (const fact of facts) {
    const scope = fact.evidenceScope;
    
    if (!scope || !scope.methodology) {
      noMethodologyFacts.push(fact);
      continue;
    }

    const key = scope.methodology;
    if (!methodologyMap.has(key)) {
      methodologyMap.set(key, []);
    }
    methodologyMap.get(key)!.push(fact);
  }

  // If fewer than 3 methodologies (including "no methodology" group), don't group
  const totalGroups = methodologyMap.size + (noMethodologyFacts.length > 0 ? 1 : 0);
  if (totalGroups < 3) {
    return null;
  }

  // Build groups
  const groups: MethodologyGroup[] = [];

  // Add methodology-specific groups
  for (const [methodology, factsInGroup] of methodologyMap.entries()) {
    groups.push({
      key: methodology,
      name: methodology,
      icon: getMethodologyIcon(methodology),
      facts: factsInGroup,
    });
  }

  // Add "general" group if there are facts without methodology
  if (noMethodologyFacts.length > 0) {
    groups.push({
      key: '_no_methodology',
      name: 'General/Other Sources',
      icon: 'üì∞',
      facts: noMethodologyFacts,
    });
  }

  // Sort groups by number of facts (descending)
  groups.sort((a, b) => b.facts.length - a.facts.length);

  return groups;
}

/**
 * Returns an appropriate emoji icon for a methodology.
 */
function getMethodologyIcon(methodology: string): string {
  const lower = methodology.toLowerCase();
  
  if (lower.includes('iso') || lower.includes('lca')) return 'üìä';
  if (lower.includes('greet') || lower.includes('model')) return 'üî¨';
  if (lower.includes('legal') || lower.includes('law')) return '‚öñÔ∏è';
  if (lower.includes('court') || lower.includes('judicial')) return 'üèõÔ∏è';
  if (lower.includes('academic') || lower.includes('scholar')) return 'üéì';
  if (lower.includes('journal') || lower.includes('peer')) return 'üìö';
  if (lower.includes('government') || lower.includes('official')) return 'üè¢';
  
  return 'üìä'; // Default
}
```

#### Subtask 2.2: Create MethodologySubGroup Component

**File:** `apps/web/src/app/jobs/[id]/components/MethodologySubGroup.tsx` (NEW)

```typescript
import React, { useState } from 'react';
import styles from './MethodologySubGroup.module.css';
import type { MethodologyGroup } from '../utils/methodologyGrouping';

interface MethodologySubGroupProps {
  group: MethodologyGroup;
  renderFact: (fact: any) => React.ReactNode;
}

export function MethodologySubGroup({ group, renderFact }: MethodologySubGroupProps) {
  const [isExpanded, setIsExpanded] = useState(true);

  return (
    <div className={styles.methodologyGroup}>
      <button
        className={styles.groupHeader}
        onClick={() => setIsExpanded(!isExpanded)}
        aria-expanded={isExpanded}
      >
        <span className={styles.icon}>{group.icon}</span>
        <span className={styles.name}>{group.name}</span>
        <span className={styles.count}>({group.facts.length} facts)</span>
        <span className={styles.chevron}>{isExpanded ? '‚ñº' : '‚ñ∂'}</span>
      </button>
      
      {isExpanded && (
        <div className={styles.groupContent}>
          {group.facts.map((fact) => renderFact(fact))}
        </div>
      )}
    </div>
  );
}
```

#### Subtask 2.3: Add MethodologySubGroup Styles

**File:** `apps/web/src/app/jobs/[id]/components/MethodologySubGroup.module.css` (NEW)

```css
.methodologyGroup {
  margin: 16px 0;
  border: 1px solid #e0e0e0;
  border-radius: 8px;
  overflow: hidden;
}

.groupHeader {
  width: 100%;
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 12px 16px;
  background: #f8f9fa;
  border: none;
  cursor: pointer;
  font-family: inherit;
  font-size: 14px;
  font-weight: 600;
  color: #2c3e50;
  transition: background 0.2s;
}

.groupHeader:hover {
  background: #e9ecef;
}

.icon {
  font-size: 18px;
}

.name {
  flex: 1;
  text-align: left;
}

.count {
  color: #6c757d;
  font-size: 12px;
  font-weight: 400;
}

.chevron {
  font-size: 10px;
  color: #6c757d;
  transition: transform 0.2s;
}

.groupContent {
  padding: 8px;
  background: #fff;
}

/* Dark mode support */
@media (prefers-color-scheme: dark) {
  .methodologyGroup {
    border-color: #3a3a3a;
  }

  .groupHeader {
    background: #2a2a2a;
    color: #e0e0e0;
  }

  .groupHeader:hover {
    background: #333333;
  }

  .groupContent {
    background: #1e1e1e;
  }
}
```

#### Subtask 2.4: Integrate into ClaimsGroupedByScope

**File:** `apps/web/src/app/jobs/[id]/components/ClaimsGroupedByScope.tsx`

**Changes:**

1. Import utilities:
```typescript
import { groupFactsByMethodology } from '../utils/methodologyGrouping';
import { MethodologySubGroup } from './MethodologySubGroup';
```

2. Add methodology grouping logic (inside the render for each context):
```typescript
// BEFORE: Direct fact rendering
{context.facts.map((fact) => (
  <FactCard key={fact.id} fact={fact} />
))}

// AFTER: Adaptive methodology grouping (with pipeline check)
{(() => {
  // Only group if we have structured facts (orchestrated & canonical pipelines)
  if (!context.facts || context.facts.length === 0) {
    return <div className={styles.noFacts}>No facts available for this context.</div>;
  }

  const methodologyGroups = groupFactsByMethodology(context.facts);
  
  if (methodologyGroups) {
    // Show methodology sub-grouping
    return methodologyGroups.map((group) => (
      <MethodologySubGroup
        key={group.key}
        group={group}
        renderFact={(fact) => <FactCard key={fact.id} fact={fact} />}
      />
    ));
  } else {
    // Show flat list
    return context.facts.map((fact) => (
      <FactCard key={fact.id} fact={fact} />
    ));
  }
})()}
```

**Acceptance Criteria:**
- [ ] Sub-grouping only appears when 3+ methodologies detected
- [ ] Groups are collapsible/expandable
- [ ] Groups default to expanded state
- [ ] Groups show fact count in header
- [ ] Groups sorted by number of facts (largest first)
- [ ] "General/Other" group appears last
- [ ] Icons match methodology types appropriately
- [ ] Falls back to flat list when fewer than 3 methodologies
- [ ] **Pipeline safety:** Handles missing or empty facts array gracefully

---

### Task 3: Enhance ArticleFrame LLM Guidance

**Priority:** High  
**Effort:** S (3 hours)  
**Files to Modify:**
- `apps/web/src/lib/analyzer/prompts/base/understand-base.ts` (UPDATE)
- `apps/web/src/lib/analyzer/prompts/base/dynamic-plan-base.ts` (UPDATE)

**‚ö†Ô∏è IMPORTANT: Multi-Pipeline Support**

ArticleFrame guidance needs to be added to prompts for **ALL THREE pipelines**:
1. **Orchestrated:** Uses `understand-base.ts`
2. **Monolithic Canonical:** Uses `understand-base.ts` (same as orchestrated)
3. **Monolithic Dynamic:** Uses `dynamic-plan-base.ts` and `dynamic-analysis-base.ts`

**Data Field Mapping:**
- **Orchestrated & Canonical:** `result.understanding.analysisContext` (singular) = ArticleFrame
- **Dynamic:** `result.rawJson.articleFrame` (if LLM populates it in free-form JSON)

#### Subtask 3.1: Update TERMINOLOGY Section (Orchestrated & Canonical)

**File:** `apps/web/src/lib/analyzer/prompts/base/understand-base.ts`

**Location:** Find the `## TERMINOLOGY (CRITICAL)` section (around lines 21-25)

**Changes:**

```typescript
// BEFORE:
return `You are a fact-checking analyst. Your task is to extract claims and generate targeted search queries.

## TERMINOLOGY (CRITICAL)

**AnalysisContext**: Top-level bounded analytical frame requiring separate, independent analysis and verdict (output as \`detectedScopes\`)
**EvidenceScope**: Per-fact source methodology metadata - DIFFERENT from AnalysisContext
**ArticleFrame**: Narrative background framing - NOT a reason to split analysis

## CURRENT DATE
...`

// AFTER:
return `You are a fact-checking analyst. Your task is to extract claims and generate targeted search queries.

## TERMINOLOGY (CRITICAL)

**AnalysisContext**: Top-level bounded analytical frame requiring separate, independent analysis and verdict (output as \`detectedScopes\`)
**EvidenceScope**: Per-fact source methodology metadata - DIFFERENT from AnalysisContext
**ArticleFrame**: Narrative background framing - NOT a reason to split analysis

## ARTICLE FRAME GUIDANCE

**articleFrame** (optional string field):
- The broader topic or narrative setting of the input article
- Editorial/thematic framing that provides context
- Answer: "What's the general subject area or backdrop?"
- Examples:
  * "Climate policy and decarbonization pathways"
  * "Brazilian post-coup legal accountability (2023-2024)"
  * "US-EU antitrust coordination in tech mergers"
  * "Transportation sector environmental impact assessment"
- **When to populate:** Only when input is an article with clear broader thematic frame
- **When to leave empty:** Simple claims, OR when frame is identical to thesis
- **Distinguish from articleThesis:** Frame is the setting, thesis is the specific assertion

**articleThesis** (required string field):
- What the article/input specifically asserts or claims
- The main argument or claim being made
- Answer: "What is being claimed?"
- Examples:
  * "Hydrogen fuel cell vehicles are more efficient than battery electric vehicles"
  * "Bolsonaro's trials were politically motivated"
  * "The FTC will approve the Microsoft-Activision merger"

**KEY RULE**: If you cannot clearly distinguish articleFrame from articleThesis, leave articleFrame empty. It is optional.

## CURRENT DATE
...`
```

#### Subtask 3.2: Add Examples to Prompt

**Add concrete examples section:**

```typescript
## ARTICLE FRAME EXAMPLES

Example 1 (Simple Claim):
Input: "Hydrogen cars are more efficient than electric cars"
‚Üí articleFrame: "" (empty - no article context)
‚Üí articleThesis: "Hydrogen cars are more efficient than electric cars"

Example 2 (News Article with Clear Frame):
Input: News article titled "Brazilian Democracy Under Threat: Bolsonaro Faces Legal Challenges"
‚Üí articleFrame: "Brazilian democratic crisis and post-coup accountability (2023-2024)"
‚Üí articleThesis: "Bolsonaro faces multiple legal challenges in TSE and STF courts"

Example 3 (Scientific Paper):
Input: Academic paper "Life-Cycle Assessment of Hydrogen FCEVs: A Review"
‚Üí articleFrame: "Life-cycle environmental impact of transportation alternatives"
‚Üí articleThesis: "Hydrogen FCEVs show varying efficiency profiles under different LCA methodologies"

Example 4 (Frame Redundant with Thesis - Leave Empty):
Input: "Study: Hydrogen efficiency is 40% using WTW methodology"
‚Üí articleFrame: "" (empty - frame would duplicate thesis)
‚Üí articleThesis: "Hydrogen efficiency is 40% using WTW methodology"
```

#### Subtask 3.3: Add ArticleFrame Guidance to Dynamic Pipeline Prompts

**File:** `apps/web/src/lib/analyzer/prompts/base/dynamic-plan-base.ts`

**Location:** After the main task description

**Changes:**

Add the same ARTICLE FRAME GUIDANCE and ARTICLE FRAME EXAMPLES sections as in understand-base.ts.

**Note:** The dynamic pipeline outputs free-form JSON, so the LLM can populate `articleFrame` in its response if it detects one. Update the prompt to suggest including this field when appropriate:

```typescript
## OUTPUT GUIDANCE

When planning your analysis, consider:
- **articleFrame** (optional): Broader narrative/thematic setting of the input
- **articleThesis**: Main assertion or claim being made
- **keyQuestions**: Specific questions to investigate
- **searchQueries**: Targeted queries for evidence gathering
- **analysisApproach**: Recommended methodology

Only populate articleFrame if it's clearly distinct from articleThesis.
```

**Acceptance Criteria:**
- [ ] TERMINOLOGY section includes ArticleFrame definition **(understand-base.ts)**
- [ ] Clear distinction between articleFrame, articleThesis, and analysisContexts
- [ ] 4+ concrete examples showing when to populate vs leave empty
- [ ] Guidance emphasizes articleFrame is optional
- [ ] Rule states: "When in doubt, leave empty"
- [ ] **Dynamic pipeline prompts include same guidance (dynamic-plan-base.ts)**

---

### Task 4: Add ArticleFrame UI Display

**Priority:** Medium  
**Effort:** S (3 hours)  
**Files to Modify:**
- `apps/web/src/app/jobs/[id]/components/ArticleFrameBanner.tsx` (NEW)
- `apps/web/src/app/jobs/[id]/page.tsx` (UPDATE)

#### Subtask 4.1: Create ArticleFrameBanner Component

**File:** `apps/web/src/app/jobs/[id]/components/ArticleFrameBanner.tsx` (NEW)

```typescript
import React from 'react';
import styles from './ArticleFrameBanner.module.css';

interface ArticleFrameBannerProps {
  articleFrame: string;
}

export function ArticleFrameBanner({ articleFrame }: ArticleFrameBannerProps) {
  // Don't render if empty
  if (!articleFrame || articleFrame.trim() === '') {
    return null;
  }

  return (
    <div className={styles.banner}>
      <div className={styles.icon}>üìÑ</div>
      <div className={styles.content}>
        <div className={styles.label}>Article Context</div>
        <div className={styles.text}>{articleFrame}</div>
      </div>
    </div>
  );
}
```

#### Subtask 4.2: Add Banner Styles

**File:** `apps/web/src/app/jobs/[id]/components/ArticleFrameBanner.module.css` (NEW)

```css
.banner {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  padding: 16px;
  margin: 16px 0;
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  border-left: 4px solid #3498db;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

.icon {
  font-size: 24px;
  line-height: 1;
  flex-shrink: 0;
}

.content {
  flex: 1;
}

.label {
  font-size: 12px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: #6c757d;
  margin-bottom: 4px;
}

.text {
  font-size: 14px;
  line-height: 1.5;
  color: #2c3e50;
}

/* Dark mode */
@media (prefers-color-scheme: dark) {
  .banner {
    background: linear-gradient(135deg, #2a2a2a 0%, #1e1e1e 100%);
    border-left-color: #5dade2;
  }

  .label {
    color: #95a5a6;
  }

  .text {
    color: #ecf0f1;
  }
}
```

#### Subtask 4.3: Integrate into Page Layout

**File:** `apps/web/src/app/jobs/[id]/page.tsx`

**Location:** Find where `ArticleSummaryBox` is rendered (around line 537)

**Changes:**

1. Import component:
```typescript
import { ArticleFrameBanner } from './components/ArticleFrameBanner';
```

2. Add banner after ArticleSummaryBox with **multi-pipeline support**:
```typescript
{/* v2.6.31: Show article summary FIRST */}
{twoPanelSummary?.articleSummary && (
  <ArticleSummaryBox
    articleSummary={twoPanelSummary.articleSummary}
  />
)}

{/* v2.8: Show article frame if populated - MULTI-PIPELINE SUPPORT */}
{(() => {
  // Try to get articleFrame from different pipeline outputs
  let articleFrame = null;
  
  // Orchestrated & Canonical: result.understanding.analysisContext (singular)
  if (result?.understanding?.analysisContext) {
    articleFrame = result.understanding.analysisContext;
  }
  
  // Dynamic: result.rawJson.articleFrame (if LLM populated it)
  if (!articleFrame && result?.rawJson?.articleFrame) {
    articleFrame = result.rawJson.articleFrame;
  }
  
  // Only render banner if we found an articleFrame
  if (articleFrame) {
    return <ArticleFrameBanner articleFrame={articleFrame} />;
  }
  
  return null;
})()}

{/* v2.6.33: Show transformed input if different from original */}
{impliedClaim && (
  <TransformedInputBox
    originalInput={job?.inputValue || ""}
    transformedInput={impliedClaim}
  />
)}
```

**Acceptance Criteria:**
- [ ] Banner appears only when `analysisContext` field is populated **(orchestrated & canonical)**
- [ ] Banner appears when `rawJson.articleFrame` is populated **(dynamic)**
- [ ] Banner shows before TransformedInputBox
- [ ] Banner displays with article icon and "Article Context" label
- [ ] Banner is responsive on mobile
- [ ] Banner styling matches existing design system
- [ ] Dark mode styling works correctly
- [ ] **Multi-pipeline:** Works correctly for all three pipeline variants

---

### Task 5: Update Documentation

**Priority:** Medium  
**Effort:** XS (1 hour)  
**Files to Modify:**
- `Docs/REFERENCE/TERMINOLOGY.md` (UPDATE - already done)
- `Docs/DEVELOPMENT/LLM_Prompt_Improvements.md` (UPDATE)
- `CHANGELOG.md` (ADD entry for v2.8)

#### Subtask 5.1: Update LLM_Prompt_Improvements.md

**File:** `Docs/DEVELOPMENT/LLM_Prompt_Improvements.md`

**Add section:**

```markdown
## ‚úÖ IMPLEMENTED: v2.8 Enhancements

### ArticleFrame Guidance (Implemented)

**Status:** Complete in v2.8.0

**Changes:**
- Added clear definition of articleFrame vs articleThesis vs analysisContexts
- Provided 4 concrete examples showing when to populate vs leave empty
- Emphasized articleFrame is optional
- Rule: "When in doubt, leave empty"

**Prompt Location:** `apps/web/src/lib/analyzer/prompts/base/understand-base.ts`

### EvidenceScope Display (Implemented)

**Status:** Complete in v2.8.0

**UI Changes:**
- Added hoverable tooltips on facts showing EvidenceScope metadata
- Added adaptive methodology sub-grouping (3+ methodologies)
- Groups are collapsible with fact counts

**Components:**
- `EvidenceScopeTooltip.tsx` - Hoverable tooltip
- `MethodologySubGroup.tsx` - Sub-grouping component
- `methodologyGrouping.ts` - Grouping logic

**Display Location:** `apps/web/src/app/jobs/[id]/page.tsx`
```

#### Subtask 5.2: Add CHANGELOG Entry

**File:** `CHANGELOG.md`

**Add at top:**

```markdown
## [2.8.0] - 2026-01-XX

### Added
- **EvidenceScope Display**: Facts now show hoverable tooltips with source methodology details
  - Tooltips display methodology, boundaries, geographic scope, and temporal period
  - Adaptive methodology sub-grouping when 3+ distinct methodologies detected
  - Collapsible groups with fact counts
  - Keyboard accessible (Tab + Enter)

- **ArticleFrame UI**: Optional context banner showing broader article topic
  - Displays when `analysisContext` field is populated by LLM
  - Shows editorial/thematic framing distinct from main thesis
  - Positioned after article summary, before transformed input

### Changed
- **LLM Prompts**: Enhanced ArticleFrame guidance in understand-base.ts
  - Added clear definition and usage rules
  - Provided 4 concrete examples
  - Emphasized field is optional (only populate when distinct from thesis)

### Improved
- **UI Transparency**: Users can now see source methodology used for each fact
- **Evidence Quality**: Methodology grouping makes evidence diversity visible
- **Context Clarity**: ArticleFrame banner helps users understand topic scope

### Technical
- New components: `EvidenceScopeTooltip`, `MethodologySubGroup`, `ArticleFrameBanner`
- New utility: `methodologyGrouping.ts` with adaptive grouping logic
- Updated prompts: `understand-base.ts` with ArticleFrame guidance
```

---

## Testing Plan

### Unit Tests

**File:** `apps/web/src/app/jobs/[id]/utils/methodologyGrouping.test.ts` (NEW)

```typescript
import { describe, it, expect } from 'vitest';
import { groupFactsByMethodology } from './methodologyGrouping';

describe('methodologyGrouping', () => {
  it('returns null when fewer than 3 methodologies', () => {
    const facts = [
      { id: 'F1', evidenceScope: { methodology: 'ISO 14040' } },
      { id: 'F2', evidenceScope: { methodology: 'ISO 14040' } },
    ];
    expect(groupFactsByMethodology(facts as any)).toBeNull();
  });

  it('groups facts by methodology when 3+ methodologies present', () => {
    const facts = [
      { id: 'F1', evidenceScope: { methodology: 'ISO 14040' } },
      { id: 'F2', evidenceScope: { methodology: 'GREET Model' } },
      { id: 'F3', evidenceScope: { methodology: 'JRC-EU' } },
    ];
    const groups = groupFactsByMethodology(facts as any);
    expect(groups).toHaveLength(3);
  });

  it('creates "General" group for facts without methodology', () => {
    const facts = [
      { id: 'F1', evidenceScope: { methodology: 'ISO 14040' } },
      { id: 'F2', evidenceScope: { methodology: 'GREET Model' } },
      { id: 'F3', evidenceScope: null },
      { id: 'F4', evidenceScope: { methodology: 'JRC-EU' } },
    ];
    const groups = groupFactsByMethodology(facts as any);
    const generalGroup = groups?.find(g => g.key === '_no_methodology');
    expect(generalGroup).toBeDefined();
    expect(generalGroup?.facts).toHaveLength(1);
  });

  it('sorts groups by fact count descending', () => {
    const facts = [
      { id: 'F1', evidenceScope: { methodology: 'A' } },
      { id: 'F2', evidenceScope: { methodology: 'B' } },
      { id: 'F3', evidenceScope: { methodology: 'B' } },
      { id: 'F4', evidenceScope: { methodology: 'C' } },
      { id: 'F5', evidenceScope: { methodology: 'C' } },
      { id: 'F6', evidenceScope: { methodology: 'C' } },
    ];
    const groups = groupFactsByMethodology(facts as any);
    expect(groups![0].facts).toHaveLength(3); // C (3 facts)
    expect(groups![1].facts).toHaveLength(2); // B (2 facts)
    expect(groups![2].facts).toHaveLength(1); // A (1 fact)
  });
});
```

### Integration Tests

**File:** `apps/web/src/app/jobs/[id]/components/EvidenceScopeTooltip.test.tsx` (NEW)

```typescript
import { describe, it, expect } from 'vitest';
import { render, screen, fireEvent } from '@testing-library/react';
import { EvidenceScopeTooltip } from './EvidenceScopeTooltip';

describe('EvidenceScopeTooltip', () => {
  it('renders info icon when scope has data', () => {
    const scope = { name: 'Test', methodology: 'ISO 14040' };
    render(<EvidenceScopeTooltip evidenceScope={scope} />);
    expect(screen.getByText('‚ÑπÔ∏è')).toBeInTheDocument();
  });

  it('does not render when scope has no meaningful data', () => {
    const scope = { name: '' };
    const { container } = render(<EvidenceScopeTooltip evidenceScope={scope} />);
    expect(container.firstChild).toBeNull();
  });

  it('shows tooltip on hover', () => {
    const scope = { name: 'Test', methodology: 'ISO 14040' };
    render(<EvidenceScopeTooltip evidenceScope={scope} />);
    
    const icon = screen.getByRole('button');
    fireEvent.mouseEnter(icon);
    
    expect(screen.getByText('üìä Evidence Scope')).toBeVisible();
    expect(screen.getByText(/ISO 14040/)).toBeVisible();
  });

  it('is keyboard accessible', () => {
    const scope = { methodology: 'ISO 14040' };
    render(<EvidenceScopeTooltip evidenceScope={scope} />);
    
    const icon = screen.getByRole('button');
    icon.focus();
    fireEvent.focus(icon);
    
    expect(screen.getByRole('tooltip')).toBeVisible();
  });
});
```

### Manual Testing Checklist

#### EvidenceScope Tooltips
- [ ] Info icon appears next to facts with EvidenceScope
- [ ] No icon appears for facts without EvidenceScope
- [ ] Hover shows tooltip with all populated fields
- [ ] Tab navigation works (keyboard accessible)
- [ ] Tooltip positioning is correct (above icon, centered)
- [ ] Tooltip arrow points to icon
- [ ] Mobile: Tooltip doesn't overflow screen
- [ ] Dark mode: Tooltip has proper contrast

#### Methodology Sub-Grouping
- [ ] Sub-grouping only appears with 3+ methodologies
- [ ] Groups are collapsible/expandable
- [ ] Groups default to expanded
- [ ] Chevron icon rotates on expand/collapse
- [ ] Fact counts are accurate
- [ ] Groups sorted by count (largest first)
- [ ] "General/Other" group appears last
- [ ] Icons match methodology types
- [ ] Flat list fallback works (<3 methodologies)
- [ ] **Pipeline check:** Feature only applies to orchestrated & canonical (no crash on dynamic)

#### ArticleFrame Banner
- [ ] Banner only appears when field is populated
- [ ] Banner shows "Article Context" label
- [ ] Banner positioned after ArticleSummaryBox
- [ ] Banner is responsive on mobile
- [ ] Dark mode styling works
- [ ] Banner has proper visual hierarchy
- [ ] **Multi-pipeline:** Works with orchestrated, canonical, AND dynamic outputs

### End-to-End Testing

**Test Case 1: Hydrogen Efficiency (Multi-Methodology) - ORCHESTRATED & CANONICAL**

1. Submit input: "Is hydrogen more efficient than electric cars?"
2. Select pipeline: **Orchestrated** OR **Monolithic Canonical**
3. Wait for analysis completion
4. Verify:
   - Multiple AnalysisContexts detected (WTW, TTW)
   - Facts show info icons with EvidenceScope tooltips
   - Hovering shows methodology tooltips
   - If 3+ methodologies: sub-grouping appears
   - Groups are collapsible

**Test Case 2: Bolsonaro Trials (Multi-Context) - ALL PIPELINES**

1. Submit: "Were the TSE and STF cases against Bolsonaro fair?"
2. Test with each pipeline variant:
   - **Orchestrated:** Should detect 2 AnalysisContexts, show EvidenceScope tooltips, methodology grouping
   - **Canonical:** Should detect 2 AnalysisContexts, show EvidenceScope tooltips, methodology grouping
   - **Dynamic:** Should show citations with timestamps, ArticleFrame banner
3. Verify:
   - ArticleFrame banner may appear (all pipelines)
   - Facts show EvidenceScope tooltips (orchestrated & canonical only)
   - Legal analysis sources grouped separately (orchestrated & canonical only)
   - Citations show accessed timestamps (dynamic only)

**Test Case 3: Simple Claim (No Frame) - ALL PIPELINES**

1. Submit: "Water is wet"
2. Test with each pipeline variant
3. Verify:
   - No ArticleFrame banner (field should be empty)
   - 1 AnalysisContext (orchestrated & canonical)
   - Facts may have tooltips if methodology present (orchestrated & canonical)
   - Dynamic shows citations and summary

**Test Case 4: Dynamic Pipeline Specific**

1. Submit: News article URL (multi-topic)
2. Select pipeline: **Monolithic Dynamic**
3. Verify:
   - ArticleFrame banner appears (if LLM populates it)
   - Citations show with timestamps
   - Free-form analysis displays correctly
   - No methodology grouping attempted (feature N/A for dynamic)

---

## Implementation Checklist

### Pre-Implementation
- [ ] Create feature branch: `feature/v2.8-evidence-scope-display`
- [ ] Review analysis document
- [ ] Set up local development environment
- [ ] Verify tests pass on main branch

### Task 1: EvidenceScope Tooltips
- [ ] Create `EvidenceScopeTooltip.tsx`
- [ ] Create `EvidenceScopeTooltip.module.css`
- [ ] Integrate into fact display
- [ ] Write unit tests
- [ ] Manual testing (all scenarios)

### Task 2: Methodology Sub-Grouping
- [ ] Create `methodologyGrouping.ts` utility
- [ ] Create `MethodologySubGroup.tsx` component
- [ ] Create `MethodologySubGroup.module.css`
- [ ] Integrate into `ClaimsGroupedByScope.tsx`
- [ ] Write unit tests for grouping logic
- [ ] Write component tests
- [ ] Manual testing (adaptive behavior)

### Task 3: ArticleFrame Guidance
- [ ] Update `understand-base.ts` TERMINOLOGY section
- [ ] Add ArticleFrame examples
- [ ] Add usage rules
- [ ] Test with various inputs (verify LLM populates correctly)

### Task 4: ArticleFrame UI
- [ ] Create `ArticleFrameBanner.tsx`
- [ ] Create `ArticleFrameBanner.module.css`
- [ ] Integrate into page layout
- [ ] Write component tests
- [ ] Manual testing (display/hide logic)

### Task 5: Documentation
- [ ] Update `LLM_Prompt_Improvements.md`
- [ ] Add CHANGELOG entry
- [ ] Update any README sections if needed

### Testing
- [ ] Run all unit tests: `npm test`
- [ ] Run integration tests
- [ ] Manual testing checklist (all items)
- [ ] E2E testing (3 scenarios)
- [ ] Mobile testing
- [ ] Dark mode testing
- [ ] Accessibility testing (keyboard, screen reader)

### Code Review Preparation
- [ ] Lint code: `npm run lint`
- [ ] Format code: `npm run format` (if applicable)
- [ ] Review all diffs
- [ ] Ensure no console.log statements
- [ ] Verify no hardcoded test data
- [ ] Check for TypeScript errors

### Deployment
- [ ] Create PR with descriptive title
- [ ] Add screenshots to PR description
- [ ] Request code review
- [ ] Address review comments
- [ ] Merge to main
- [ ] Verify deployment to staging
- [ ] Test in staging environment
- [ ] Deploy to production

---

## Risk Assessment

### Low Risk
- ‚úÖ **EvidenceScope tooltips**: Additive feature, doesn't change existing behavior
- ‚úÖ **ArticleFrame banner**: Conditional display, doesn't affect analysis
- ‚úÖ **Documentation updates**: No code impact

### Medium Risk
- ‚ö†Ô∏è **Methodology sub-grouping**: Complex logic, potential edge cases
  - **Mitigation**: Comprehensive unit tests, fallback to flat list
- ‚ö†Ô∏è **Prompt changes**: Could affect LLM behavior
  - **Mitigation**: A/B testing recommended, monitor ArticleFrame population rate

### High Risk
- None for v2.8 (no breaking changes, all additive features)

---

## Performance Considerations

### Tooltip Component
- **Concern**: Many tooltips on page with many facts
- **Mitigation**: Lazy rendering (only when visible), CSS-only tooltips considered but rejected for flexibility

### Methodology Grouping
- **Concern**: Grouping algorithm O(n) complexity
- **Impact**: Negligible (typical fact count: 10-50)
- **Optimization**: Could add memoization if needed

### LLM Prompt Length
- **Concern**: Added guidance increases token count
- **Impact**: ~200 additional input tokens
- **Cost**: Minimal (~$0.0004 per analysis @ Claude Sonnet 4 pricing)

---

## Future Work (v3.0 - Out of Scope)

### Breaking Changes for Next Major Version

**Task:** Rename `analysisContext` ‚Üí `articleFrame`
- Database migration required
- Update all code references
- Update all documentation
- Estimated effort: M (5 days)

**Rationale:** Eliminates naming confusion between:
- `analysisContext` (singular, ArticleFrame)
- `analysisContexts` (plural, AnalysisContext array)

**Decision:** Defer to v3.0 to avoid breaking changes in v2.8

---

## Success Metrics

### Functional Metrics
- [ ] 100% of facts with EvidenceScope show tooltips
- [ ] Methodology sub-grouping appears when 3+ methodologies present
- [ ] ArticleFrame banner appears when field is populated
- [ ] 0 regressions in existing features

### Quality Metrics
- [ ] All unit tests pass
- [ ] Test coverage ‚â•80% for new code
- [ ] No TypeScript errors
- [ ] No linter warnings

### User Experience Metrics (Post-Launch)
- Monitor ArticleFrame population rate (target: 30-50% of articles)
- Monitor tooltip interaction rate
- Collect user feedback on evidence transparency

---

## Contact & Support

**Implementation Questions:**
- Review analysis document: `UI_Grouping_and_ArticleFrame_Analysis_2026-01-19.md`
- Check terminology: `Docs/REFERENCE/TERMINOLOGY.md`

**Code Review:**
- Tag: `@senior-developer` for architecture review
- Tag: `@ux-lead` for UI/UX review

---

**END OF IMPLEMENTATION PLAN**

*Estimated Total Effort: 5-7 days for senior developer*  
*Target Release: v2.8.0*  
*No Breaking Changes*
