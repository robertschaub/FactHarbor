# v2.8 Implementation Validation Checklist

**Purpose:** Use this checklist to verify implementation correctness across all three pipeline variants.

---

## Pre-Implementation Verification

### Setup
- [ ] Feature branch created: `feature/v2.8-evidence-scope-display`
- [ ] All three pipelines currently working (test with existing data)
- [ ] Local development environment running
- [ ] Git working directory clean

### Documentation Review
- [ ] Read full plan: `v2.8_EvidenceScope_Implementation_Plan.md`
- [ ] Read summary: `v2.8_Implementation_Summary.md`
- [ ] Read analysis: `UI_Grouping_and_ArticleFrame_Analysis_2026-01-19.md`
- [ ] Understand data structure differences (see summary doc)

---

## Component Creation Validation

### EvidenceScopeTooltip Component

**File:** `apps/web/src/app/jobs/[id]/components/EvidenceScopeTooltip.tsx`

- [ ] Component created with TypeScript interface
- [ ] Component checks if `evidenceScope` has meaningful data
- [ ] Returns `null` if no data (not just empty div)
- [ ] Tooltip uses CSS for positioning (not JS)
- [ ] Keyboard accessible (tabIndex, onFocus, onBlur)
- [ ] ARIA labels present (`role="button"`, `aria-label`, `role="tooltip"`)
- [ ] Shows all EvidenceScope fields (methodology, boundaries, geographic, temporal)

**CSS File:** `apps/web/src/app/jobs/[id]/components/EvidenceScopeTooltip.module.css`

- [ ] Tooltip positioned absolutely
- [ ] Z-index set appropriately (>= 1000)
- [ ] Fade-in animation
- [ ] Arrow pointing to icon
- [ ] Dark mode styles (@media prefers-color-scheme: dark)
- [ ] Mobile responsive (min-width adjustments)

**Integration Test:**

```typescript
// Test in browser console after implementation
const testScope = { methodology: "ISO 14040", geographic: "EU" };
// Should show tooltip with both fields
```

---

### MethodologySubGroup Component

**File:** `apps/web/src/app/jobs/[id]/components/MethodologySubGroup.tsx`

- [ ] Component accepts `group` and `renderFact` props
- [ ] Collapsible/expandable state (useState)
- [ ] Defaults to expanded (isExpanded = true)
- [ ] Shows fact count in header
- [ ] Shows icon from group metadata
- [ ] Chevron rotates on expand/collapse
- [ ] Renders facts using provided `renderFact` function

**CSS File:** `apps/web/src/app/jobs/[id]/components/MethodologySubGroup.module.css`

- [ ] Group header styled as button
- [ ] Hover state
- [ ] Chevron transition animation
- [ ] Dark mode support
- [ ] Mobile responsive

**Utility File:** `apps/web/src/app/jobs/[id]/utils/methodologyGrouping.ts`

- [ ] `groupFactsByMethodology()` returns `null` when <3 methodologies
- [ ] Creates separate groups for each methodology
- [ ] Creates "General/Other" group for facts without methodology
- [ ] Sorts groups by fact count (descending)
- [ ] `getMethodologyIcon()` returns appropriate emojis
- [ ] TypeScript types exported (`MethodologyGroup`)

**Unit Test:** `methodologyGrouping.test.ts`

- [ ] Test: Returns null when <3 methodologies
- [ ] Test: Groups facts by methodology when 3+ present
- [ ] Test: Creates "General" group for facts without methodology
- [ ] Test: Sorts groups by count descending

---

### ArticleFrameBanner Component

**File:** `apps/web/src/app/jobs/[id]/components/ArticleFrameBanner.tsx`

- [ ] Component accepts `articleFrame: string` prop
- [ ] Returns `null` if `articleFrame` is empty or whitespace
- [ ] Shows "Article Context" label
- [ ] Shows document icon (ðŸ“„)
- [ ] Minimal, clean design

**CSS File:** `apps/web/src/app/jobs/[id]/components/ArticleFrameBanner.module.css`

- [ ] Gradient background
- [ ] Left border accent
- [ ] Proper spacing and padding
- [ ] Dark mode support
- [ ] Mobile responsive

---

## Integration Validation

### EvidenceScope Tooltip Integration

**File:** `apps/web/src/app/jobs/[id]/page.tsx`

- [ ] Import: `import { EvidenceScopeTooltip } from './components/EvidenceScopeTooltip';`
- [ ] Integrated into fact display section
- [ ] Conditional rendering: `{fact.evidenceScope && <EvidenceScopeTooltip ... />}`
- [ ] No crash when `evidenceScope` is undefined

**Pipeline Testing:**

```bash
# Test with orchestrated pipeline
curl -X POST http://localhost:3000/api/analyze \
  -H "Content-Type: application/json" \
  -d '{"inputType":"claim","inputValue":"Hydrogen is more efficient","pipelineVariant":"orchestrated"}'

# Check result - should have facts with evidenceScope
```

- [ ] **Orchestrated:** Tooltips appear on facts
- [ ] **Canonical:** Tooltips appear on facts
- [ ] **Dynamic:** No tooltips (no ExtractedFacts) - no crash

---

### Methodology Sub-Grouping Integration

**File:** `apps/web/src/app/jobs/[id]/components/ClaimsGroupedByScope.tsx`

- [ ] Import: `import { groupFactsByMethodology } from '../utils/methodologyGrouping';`
- [ ] Import: `import { MethodologySubGroup } from './MethodologySubGroup';`
- [ ] Safety check: `if (!context.facts || context.facts.length === 0)`
- [ ] Call `groupFactsByMethodology(context.facts)`
- [ ] Conditional rendering: grouped view OR flat list
- [ ] `renderFact` passed to `MethodologySubGroup`

**Visual Verification:**

- [ ] **0-2 methodologies:** Shows flat list
- [ ] **3+ methodologies:** Shows grouped view with headers
- [ ] Groups are collapsible
- [ ] Fact counts are accurate
- [ ] Icons match methodology types
- [ ] "General/Other" group appears last

**Pipeline Testing:**

- [ ] **Orchestrated:** Sub-grouping works (if 3+ methodologies)
- [ ] **Canonical:** Sub-grouping works (if 3+ methodologies)
- [ ] **Dynamic:** No sub-grouping attempted (no crash)

---

### ArticleFrame Banner Integration

**File:** `apps/web/src/app/jobs/[id]/page.tsx`

- [ ] Import: `import { ArticleFrameBanner } from './components/ArticleFrameBanner';`
- [ ] Positioned after `ArticleSummaryBox`
- [ ] Positioned before `TransformedInputBox`
- [ ] Multi-source fallback logic implemented:

```typescript
{(() => {
  let articleFrame = null;
  
  // Try orchestrated & canonical
  if (result?.understanding?.analysisContext) {
    articleFrame = result.understanding.analysisContext;
  }
  
  // Try dynamic
  if (!articleFrame && result?.rawJson?.articleFrame) {
    articleFrame = result.rawJson.articleFrame;
  }
  
  // Render only if found
  if (articleFrame) {
    return <ArticleFrameBanner articleFrame={articleFrame} />;
  }
  
  return null;
})()}
```

**Pipeline Testing:**

- [ ] **Orchestrated:** Banner appears when `understanding.analysisContext` populated
- [ ] **Canonical:** Banner appears when `understanding.analysisContext` populated
- [ ] **Dynamic:** Banner appears when `rawJson.articleFrame` populated
- [ ] **All:** Banner hidden when field empty
- [ ] Banner positioned correctly in layout

---

## Prompt Updates Validation

### understand-base.ts (Orchestrated & Canonical)

**File:** `apps/web/src/lib/analyzer/prompts/base/understand-base.ts`

- [ ] TERMINOLOGY section includes ArticleFrame definition
- [ ] Clear distinction: articleFrame vs articleThesis vs analysisContexts
- [ ] ARTICLE FRAME GUIDANCE section added
- [ ] 4+ concrete examples (generic, no domain-specific cases)
- [ ] Rule: "When in doubt, leave empty"
- [ ] Examples show when to populate vs leave empty

**Validation:**

```typescript
// Check prompt output
console.log(buildPrompt({
  task: 'understand',
  provider: 'anthropic',
  modelName: 'claude-sonnet-4',
  config: {...},
  variables: {...}
}));
// Should contain ARTICLE FRAME GUIDANCE section
```

---

### dynamic-plan-base.ts (Dynamic Pipeline)

**File:** `apps/web/src/lib/analyzer/prompts/base/dynamic-plan-base.ts`

- [ ] Same ARTICLE FRAME GUIDANCE section added
- [ ] Same examples (4+)
- [ ] OUTPUT GUIDANCE section mentions `articleFrame` as optional field
- [ ] Prompt suggests LLM can populate `articleFrame` in free-form JSON

**Validation:**

```typescript
// Check dynamic prompt
console.log(buildPrompt({
  task: 'dynamic_plan',
  provider: 'anthropic',
  modelName: 'claude-sonnet-4',
  config: {...},
  variables: {...}
}));
// Should contain ARTICLE FRAME GUIDANCE
```

---

## Testing Validation

### Unit Tests

**Run all tests:**

```bash
cd apps/web
npm test
```

- [ ] `methodologyGrouping.test.ts` passes (all 4+ tests)
- [ ] `EvidenceScopeTooltip.test.tsx` passes (all tests)
- [ ] No new test failures
- [ ] Test coverage â‰¥80% for new code

---

### E2E Testing - Multi-Pipeline

#### Test 1: Orchestrated Pipeline

**Input:** "Is hydrogen more efficient than electric cars?"

```bash
# Submit analysis
curl -X POST http://localhost:3000/api/analyze \
  -H "Content-Type: application/json" \
  -d '{
    "inputType": "claim",
    "inputValue": "Is hydrogen more efficient than electric cars?",
    "pipelineVariant": "orchestrated"
  }'
```

**Expected:**
- [ ] Analysis completes without errors
- [ ] Multiple AnalysisContexts detected (WTW, TTW, or similar)
- [ ] Facts show EvidenceScope tooltips
- [ ] If 3+ methodologies: sub-grouping appears
- [ ] ArticleFrame banner appears (if populated)

---

#### Test 2: Monolithic Canonical Pipeline

**Input:** "Were the TSE and STF cases against Bolsonaro fair?"

```bash
curl -X POST http://localhost:3000/api/analyze \
  -H "Content-Type: application/json" \
  -d '{
    "inputType": "claim",
    "inputValue": "Were the TSE and STF cases against Bolsonaro fair?",
    "pipelineVariant": "monolithic_canonical"
  }'
```

**Expected:**
- [ ] Analysis completes without errors
- [ ] 2 AnalysisContexts detected (TSE, STF)
- [ ] Facts show EvidenceScope tooltips
- [ ] Legal sources may be grouped by methodology
- [ ] ArticleFrame banner appears (if populated)

---

#### Test 3: Monolithic Dynamic Pipeline

**Input:** Any news article URL

```bash
curl -X POST http://localhost:3000/api/analyze \
  -H "Content-Type: application/json" \
  -d '{
    "inputType": "article",
    "inputValue": "https://example.com/article",
    "pipelineVariant": "monolithic_dynamic"
  }'
```

**Expected:**
- [ ] Analysis completes without errors
- [ ] `DynamicResultViewer` renders correctly
- [ ] Citations show with timestamps
- [ ] ArticleFrame banner appears (if `rawJson.articleFrame` populated)
- [ ] **No methodology grouping attempted** (feature N/A)
- [ ] **No crash due to missing ExtractedFacts**

---

#### Test 4: Simple Claim (All Pipelines)

**Input:** "Water is wet"

Test with each pipeline variant:

**Expected (All):**
- [ ] Analysis completes
- [ ] No ArticleFrame banner (field empty)
- [ ] 1 AnalysisContext
- [ ] Orchestrated/Canonical: Facts may have tooltips
- [ ] Dynamic: Citations show

---

### Accessibility Testing

#### Keyboard Navigation

- [ ] Tab to EvidenceScope tooltip icon
- [ ] Press Enter - tooltip shows
- [ ] Tab away - tooltip hides
- [ ] Tab to MethodologySubGroup header
- [ ] Press Enter - group collapses/expands

#### Screen Reader

- [ ] EvidenceScope icon announces as "button"
- [ ] EvidenceScope icon has aria-label: "Show evidence scope details"
- [ ] Tooltip has role="tooltip"
- [ ] MethodologySubGroup header has aria-expanded attribute

---

### Mobile Testing

**Test on small viewport (375px width):**

- [ ] EvidenceScope tooltip doesn't overflow screen
- [ ] Tooltip remains readable
- [ ] MethodologySubGroup headers wrap text properly
- [ ] ArticleFrame banner is responsive

**Test on medium viewport (768px width):**

- [ ] All components scale appropriately
- [ ] Layout remains consistent

---

### Dark Mode Testing

**Switch to dark mode (in browser settings):**

- [ ] EvidenceScope tooltip has dark background
- [ ] Text contrast is sufficient (WCAG AA)
- [ ] MethodologySubGroup headers styled correctly
- [ ] ArticleFrame banner gradient works in dark mode

---

## Documentation Validation

### CHANGELOG.md

**File:** `CHANGELOG.md`

- [ ] Entry added for `[2.8.0]`
- [ ] Features listed (EvidenceScope, MethodologySubGrouping, ArticleFrame)
- [ ] Changes section (LLM prompts)
- [ ] Improved section (UI transparency)
- [ ] Technical section (new components)

---

### LLM_Prompt_Improvements.md

**File:** `Docs/DEVELOPMENT/LLM_Prompt_Improvements.md`

- [ ] Section added: "âœ… IMPLEMENTED: v2.8 Enhancements"
- [ ] ArticleFrame guidance listed as implemented
- [ ] EvidenceScope display listed as implemented
- [ ] Component file paths referenced
- [ ] Status marked as "Complete in v2.8.0"

---

## Final Pre-Commit Checks

### Code Quality

```bash
# Run linter
cd apps/web
npm run lint

# Check TypeScript
npx tsc --noEmit
```

- [ ] No linter errors
- [ ] No TypeScript errors
- [ ] No unused imports
- [ ] No console.log statements

---

### Git Hygiene

```bash
# Check status
git status
```

- [ ] All new files added to git
- [ ] No unintended files staged (.env, node_modules, etc.)
- [ ] Commit message descriptive

**Suggested commit messages:**

```
feat(ui): Add EvidenceScope tooltips and methodology grouping

- Add EvidenceScopeTooltip component with hover/focus support
- Add adaptive methodology sub-grouping (3+ methodologies)
- Add ArticleFrameBanner component with multi-pipeline support
- Update prompts with ArticleFrame guidance
- Support all three pipeline variants (orchestrated, canonical, dynamic)

Related: v2.8 UI transparency improvements
```

---

### Performance Check

**Monitor page load time:**

```javascript
// In browser console on jobs page
performance.now(); // Before
// Navigate/interact
performance.now(); // After
// Difference should be <50ms added overhead
```

- [ ] Page load time impact <50ms
- [ ] No layout shift when tooltips appear
- [ ] Smooth animations

---

## Regression Testing

### Existing Features Still Work

- [ ] Analysis submission works (all 3 pipelines)
- [ ] Job results page loads
- [ ] Existing fact display unchanged (except new tooltip)
- [ ] Verdict calculation unaffected
- [ ] Search functionality works
- [ ] No console errors

---

## Sign-Off Checklist

### Implementation Complete

- [ ] All components created
- [ ] All integrations done
- [ ] All prompts updated
- [ ] All tests passing
- [ ] All documentation updated

### Quality Verified

- [ ] Tested with all 3 pipeline variants
- [ ] Keyboard accessible
- [ ] Mobile responsive
- [ ] Dark mode support
- [ ] No regressions

### Ready for Code Review

- [ ] Code clean and commented
- [ ] No hardcoded values
- [ ] TypeScript types defined
- [ ] Error handling present
- [ ] Edge cases handled

### Ready for PR

- [ ] Branch up to date with main
- [ ] Conflicts resolved
- [ ] Commit messages clear
- [ ] Screenshots added to PR description
- [ ] Testing notes added to PR

---

## Post-Merge Verification

### Staging Environment

- [ ] Deploy to staging
- [ ] Test all 3 pipelines in staging
- [ ] Verify ArticleFrame banner appears
- [ ] Verify tooltips work
- [ ] Verify methodology grouping

### Production Monitoring

- [ ] Monitor error rates (first 24h)
- [ ] Monitor page load times
- [ ] Monitor ArticleFrame population rate (target: 30-50% of articles)
- [ ] Collect user feedback

---

**END OF VALIDATION CHECKLIST**

*Use this checklist to ensure comprehensive testing across all pipeline variants.*
